{% extends "base.html" %}

{% block title %}Listado de Cajas{% endblock %}

{% block extra_head %}
<style>
    body { background: linear-gradient(135deg, #0f172a 0%, #0b1120 45%, #020617 100%); }
    .glass { backdrop-filter: blur(22px); background: rgba(15, 23, 42, 0.7); border: 1px solid rgba(148, 163, 184, 0.18); }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-transparent pb-16">
    <div class="mx-auto max-w-7xl px-2 sm:px-4 pt-4 sm:pt-10 text-slate-100 lg:px-10">
        <div class="mb-4 sm:mb-10 flex flex-col items-start gap-3 sm:gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div>
                <p class="text-[10px] sm:text-xs uppercase tracking-[0.35em] text-slate-400">Gestión de cajas</p>
                <h1 class="text-xl sm:text-2xl lg:text-4xl font-semibold tracking-tight">Listado de Cajas</h1>
                <p class="mt-1 sm:mt-2 text-xs sm:text-sm text-slate-300">Historial completo de aperturas y cierres de caja.</p>
            </div>
            <div class="flex gap-2 sm:gap-3 w-full sm:w-auto">
                <a href="{% url 'caja:apertura' %}" class="flex-1 sm:flex-none rounded-xl sm:rounded-2xl border border-slate-400/60 bg-white/5 px-4 sm:px-6 py-2 sm:py-3 text-xs sm:text-sm font-semibold text-slate-200 transition hover:bg-white/10 text-center">
                    Apertura
                </a>
                <a href="{% url 'caja:cierre' %}" class="flex-1 sm:flex-none rounded-xl sm:rounded-2xl border border-slate-400/60 bg-white/5 px-4 sm:px-6 py-2 sm:py-3 text-xs sm:text-sm font-semibold text-slate-200 transition hover:bg-white/10 text-center">
                    Cierre
                </a>
            </div>
        </div>

        <!-- Estadísticas -->
        <div class="mb-4 sm:mb-6 grid gap-3 sm:gap-4 grid-cols-2 md:grid-cols-4">
            <div class="glass rounded-xl sm:rounded-3xl p-4 sm:p-6 shadow-xl">
                <p class="text-[10px] sm:text-xs uppercase tracking-wider text-slate-400">Total Cajas</p>
                <p class="mt-1 sm:mt-2 text-xl sm:text-2xl lg:text-3xl font-bold text-white">{{ total_cajas }}</p>
            </div>
            <div class="glass rounded-xl sm:rounded-3xl p-4 sm:p-6 shadow-xl">
                <p class="text-[10px] sm:text-xs uppercase tracking-wider text-slate-400">Abiertas</p>
                <p class="mt-1 sm:mt-2 text-xl sm:text-2xl lg:text-3xl font-bold text-amber-400">{{ cajas_abiertas }}</p>
            </div>
            <div class="glass rounded-xl sm:rounded-3xl p-4 sm:p-6 shadow-xl">
                <p class="text-[10px] sm:text-xs uppercase tracking-wider text-slate-400">Cerradas</p>
                <p class="mt-1 sm:mt-2 text-xl sm:text-2xl lg:text-3xl font-bold text-emerald-400">{{ cajas_cerradas }}</p>
            </div>
            <div class="glass rounded-xl sm:rounded-3xl p-4 sm:p-6 shadow-xl">
                <p class="text-[10px] sm:text-xs uppercase tracking-wider text-slate-400">Total Ventas</p>
                <p class="mt-1 sm:mt-2 text-xl sm:text-2xl lg:text-3xl font-bold text-blue-400">${{ total_ventas_cerradas|floatformat:2 }}</p>
            </div>
        </div>

        <!-- Filtros -->
        <div class="glass mb-4 sm:mb-6 rounded-xl sm:rounded-3xl p-4 sm:p-6 shadow-xl">
            <form method="get" class="grid gap-3 sm:gap-4 sm:grid-cols-3">
                <div>
                    <label class="text-[10px] sm:text-xs font-semibold uppercase tracking-wide text-slate-400">Estado</label>
                    <select name="estado" class="mt-1 sm:mt-2 w-full rounded-xl sm:rounded-2xl border border-white/20 bg-white/5 px-3 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm text-slate-100">
                        <option value="">Todos</option>
                        <option value="ABIERTA" {% if estado_filtro == "ABIERTA" %}selected{% endif %}>Abierta</option>
                        <option value="CERRADA" {% if estado_filtro == "CERRADA" %}selected{% endif %}>Cerrada</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] sm:text-xs font-semibold uppercase tracking-wide text-slate-400">Local</label>
                    <select name="local" class="mt-1 sm:mt-2 w-full rounded-xl sm:rounded-2xl border border-white/20 bg-white/5 px-3 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm text-slate-100">
                        <option value="">Todos</option>
                        {% for local in locales %}
                            <option value="{{ local.id }}" {% if local_filtro == local.id|stringformat:"s" %}selected{% endif %}>{{ local.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="flex items-end">
                    <button type="submit" class="w-full rounded-xl sm:rounded-2xl bg-white px-4 sm:px-6 py-2 sm:py-3 text-xs sm:text-sm font-semibold text-slate-900 shadow-lg transition hover:bg-slate-100">
                        Filtrar
                    </button>
                </div>
            </form>
        </div>

        <!-- Tabla de cajas -->
        <div class="glass rounded-xl sm:rounded-3xl overflow-hidden shadow-xl -mx-2 sm:mx-0">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-white/10">
                    <thead class="bg-white/5">
                        <tr>
                            <th class="px-3 sm:px-6 py-3 sm:py-4 text-left text-[10px] sm:text-xs font-semibold uppercase tracking-wider text-slate-400">Local</th>
                            <th class="px-3 sm:px-6 py-3 sm:py-4 text-left text-[10px] sm:text-xs font-semibold uppercase tracking-wider text-slate-400 hidden sm:table-cell">Fecha Apertura</th>
                            <th class="px-3 sm:px-6 py-3 sm:py-4 text-left text-[10px] sm:text-xs font-semibold uppercase tracking-wider text-slate-400 hidden md:table-cell">Usuario</th>
                            <th class="px-3 sm:px-6 py-3 sm:py-4 text-right text-[10px] sm:text-xs font-semibold uppercase tracking-wider text-slate-400">Monto Inicial</th>
                            <th class="px-3 sm:px-6 py-3 sm:py-4 text-right text-[10px] sm:text-xs font-semibold uppercase tracking-wider text-slate-400 hidden lg:table-cell">Total Esperado</th>
                            <th class="px-3 sm:px-6 py-3 sm:py-4 text-right text-[10px] sm:text-xs font-semibold uppercase tracking-wider text-slate-400 hidden lg:table-cell">Monto Cierre</th>
                            <th class="px-3 sm:px-6 py-3 sm:py-4 text-right text-[10px] sm:text-xs font-semibold uppercase tracking-wider text-slate-400 hidden lg:table-cell">Diferencia</th>
                            <th class="px-3 sm:px-6 py-3 sm:py-4 text-center text-[10px] sm:text-xs font-semibold uppercase tracking-wider text-slate-400">Estado</th>
                            <th class="px-3 sm:px-6 py-3 sm:py-4 text-center text-[10px] sm:text-xs font-semibold uppercase tracking-wider text-slate-400">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/10 bg-white/5">
                        {% for caja in cajas %}
                            <tr class="hover:bg-white/10 transition">
                                <td class="px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm text-slate-200">
                                    {{ caja.local.nombre }}
                                    <div class="text-[10px] sm:text-xs text-slate-400 mt-0.5 sm:hidden">{{ caja.fecha_apertura|date:"d/m/Y H:i" }}</div>
                                </td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm text-slate-300 hidden sm:table-cell">{{ caja.fecha_apertura|date:"d/m/Y H:i" }}</td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm text-slate-300 hidden md:table-cell">{{ caja.usuario_apertura.get_short_name|default:caja.usuario_apertura.username }}</td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 text-right text-xs sm:text-sm font-semibold text-slate-200">${{ caja.monto_inicial_ars|floatformat:2 }}</td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 text-right text-xs sm:text-sm font-semibold text-slate-200 hidden lg:table-cell">${{ caja.total_esperado_ars|floatformat:2 }}</td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 text-right text-xs sm:text-sm font-semibold text-slate-200 hidden lg:table-cell">
                                    {% if caja.monto_cierre_real_ars %}
                                        ${{ caja.monto_cierre_real_ars|floatformat:2 }}
                                    {% else %}
                                        <span class="text-slate-500">—</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 text-right text-xs sm:text-sm font-semibold hidden lg:table-cell">
                                    {% if caja.monto_cierre_real_ars %}
                                        {% if caja.diferencia_ars >= 0 %}
                                            <span class="text-emerald-400">+${{ caja.diferencia_ars|floatformat:2 }}</span>
                                        {% else %}
                                            <span class="text-rose-400">${{ caja.diferencia_ars|floatformat:2 }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-slate-500">—</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 text-center">
                                    {% if caja.estado == "ABIERTA" %}
                                        <span class="inline-flex rounded-full bg-amber-500/20 px-2 sm:px-3 py-1 text-[10px] sm:text-xs font-semibold text-amber-400">Abierta</span>
                                    {% else %}
                                        <span class="inline-flex rounded-full bg-emerald-500/20 px-2 sm:px-3 py-1 text-[10px] sm:text-xs font-semibold text-emerald-400">Cerrada</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 sm:px-6 py-3 sm:py-4 text-center">
                                    <a href="{% url 'caja:cierre_detalle' caja.id %}" class="text-[10px] sm:text-xs font-semibold text-blue-400 hover:text-blue-300">
                                        Ver detalle
                                    </a>
                                </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="9" class="px-6 py-12 text-center text-sm text-slate-400">
                                No hay cajas registradas.
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Paginación -->
        {% if page_obj.has_other_pages %}
            <div class="mt-4 sm:mt-6 flex justify-center gap-2 flex-wrap">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}{% if estado_filtro %}&estado={{ estado_filtro }}{% endif %}{% if local_filtro %}&local={{ local_filtro }}{% endif %}" class="rounded-xl sm:rounded-2xl border border-white/20 bg-white/5 px-3 sm:px-4 py-2 text-xs sm:text-sm font-semibold text-slate-200 transition hover:bg-white/10">
                        Anterior
                    </a>
                {% endif %}
                <span class="flex items-center rounded-xl sm:rounded-2xl border border-white/20 bg-white/5 px-3 sm:px-4 py-2 text-xs sm:text-sm font-semibold text-slate-200">
                    Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                </span>
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if estado_filtro %}&estado={{ estado_filtro }}{% endif %}{% if local_filtro %}&local={{ local_filtro }}{% endif %}" class="rounded-xl sm:rounded-2xl border border-white/20 bg-white/5 px-3 sm:px-4 py-2 text-xs sm:text-sm font-semibold text-slate-200 transition hover:bg-white/10">
                        Siguiente
                    </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

