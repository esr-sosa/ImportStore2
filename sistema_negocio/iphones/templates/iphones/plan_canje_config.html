{% extends "base.html" %}
{% load humanize %}

{% block title %}Plan Canje - Configuraci√≥n{% endblock %}

{% block extra_head %}
<style>
  body { background: linear-gradient(135deg, #0f172a 0%, #111827 50%, #020617 100%); }
  .glass { backdrop-filter: blur(20px); background: rgba(15, 23, 42, 0.75); border: 1px solid rgba(148, 163, 184, 0.2); }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-transparent pb-16">
  <div class="mx-auto max-w-7xl px-4 pt-10 sm:px-6 lg:px-10">
    <!-- Header con Logo -->
    <div class="mb-10">
      <div class="glass rounded-3xl p-6 sm:p-8 shadow-2xl border border-slate-600/30">
        <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
          <div class="flex items-start gap-6">
            <!-- Logo -->
            <div class="flex-shrink-0">
              {% if configuracion_tienda.logo %}
                <div class="flex h-20 w-20 items-center justify-center rounded-2xl border-2 border-white/90 bg-white p-3 shadow-xl ring-2 ring-white/20 sm:h-24 sm:w-24">
                  <img src="{{ configuracion_tienda.logo.url }}" alt="Logo {{ configuracion_tienda.nombre_tienda|default:'ImportStore' }}" class="h-full w-full object-contain">
                </div>
              {% else %}
                <div class="flex h-20 w-20 items-center justify-center rounded-2xl border-2 border-white/30 bg-gradient-to-br from-indigo-600/30 to-purple-600/30 text-2xl font-bold text-indigo-300 shadow-lg ring-2 ring-white/10 sm:h-24 sm:w-24">
                  {{ configuracion_tienda.nombre_tienda|default:'IS'|slice:':2'|upper }}
                </div>
              {% endif %}
            </div>
            
            <!-- Informaci√≥n -->
            <div class="flex-1">
              <p class="text-xs uppercase tracking-[0.35em] text-slate-400 mb-2">Configuraci√≥n</p>
              <h1 class="text-3xl sm:text-4xl font-bold tracking-tight text-slate-100 mb-2">Plan Canje - Valores Base</h1>
              <p class="text-sm text-slate-300 max-w-2xl">Configur√° los valores base de canje por modelo y capacidad. Todo desde ac√°, sin entrar al admin.</p>
              {% if configuracion_tienda.nombre_tienda or configuracion_tienda.cuit or configuracion_tienda.direccion %}
                <div class="mt-3 flex flex-wrap items-center gap-2 text-xs text-slate-400">
                  {% if configuracion_tienda.nombre_tienda %}
                    <span class="font-semibold text-slate-300">{{ configuracion_tienda.nombre_tienda }}</span>
                  {% endif %}
                  {% if configuracion_tienda.cuit %}
                    <span>¬∑</span>
                    <span>CUIT {{ configuracion_tienda.cuit }}</span>
                  {% endif %}
                  {% if configuracion_tienda.direccion %}
                    <span>¬∑</span>
                    <span>{{ configuracion_tienda.direccion }}</span>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
          
          <!-- Botones de Acci√≥n -->
          <div class="flex flex-col gap-3 sm:flex-row lg:flex-col xl:flex-row">
            <a href="{% url 'iphones:plan_canje_calculadora' %}" class="inline-flex w-full items-center justify-center gap-2 rounded-xl border-2 border-slate-600/40 bg-slate-800/90 px-5 py-3 text-sm font-semibold text-slate-100 shadow-lg transition hover:bg-slate-700 hover:border-slate-500 sm:w-auto">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
              Volver
            </a>
            <button id="btn-precargar-modelos" class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-emerald-600 to-teal-600 px-5 py-3 text-sm font-semibold text-white shadow-lg shadow-emerald-600/30 transition hover:from-emerald-500 hover:to-teal-500 sm:w-auto">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
              Precargar Modelos
            </button>
            <button id="btn-nueva-config" class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 px-5 py-3 text-sm font-semibold text-white shadow-lg shadow-indigo-600/30 transition hover:from-indigo-500 hover:to-purple-500 sm:w-auto">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
              Nueva Configuraci√≥n
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Formulario -->
    <div id="config-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-slate-900/80 backdrop-blur-sm px-4 py-8">
      <div class="w-full max-w-4xl max-h-[90vh] overflow-y-auto rounded-3xl border border-white/20 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-8 shadow-2xl ring-1 ring-white/10">
        <div class="mb-6 flex items-start justify-between">
          <div>
            <h2 id="modal-title" class="text-2xl font-bold text-slate-100">Nueva Configuraci√≥n</h2>
            <p class="mt-1 text-sm text-slate-400">Complet√° todos los campos para configurar el valor de canje</p>
          </div>
          <button id="cerrar-modal" class="rounded-full border border-slate-500/40 bg-slate-800/60 p-2 text-slate-300 hover:bg-slate-700 transition">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
          </button>
        </div>

        <form id="config-form" class="space-y-6">
          <input type="hidden" id="config-id" name="id" value="">
          
          <!-- Informaci√≥n B√°sica -->
          <div class="rounded-2xl border border-slate-600/40 bg-slate-800/50 p-6">
            <h3 class="mb-4 text-lg font-semibold text-slate-100">Informaci√≥n B√°sica</h3>
            <div class="grid gap-4 md:grid-cols-2">
              <div>
                <label class="block text-sm font-semibold text-slate-300 mb-2">
                  Modelo del iPhone <span class="text-rose-400">*</span>
                </label>
                <input type="text" id="modelo-iphone" name="modelo_iphone" required 
                       placeholder="Ej: iPhone 13, iPhone 14 Pro Max" 
                       class="w-full rounded-xl border-2 border-slate-600/40 bg-slate-800/90 px-4 py-3 text-sm text-slate-100 placeholder-slate-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30">
                <p class="mt-1 text-xs text-slate-500">Ingres√° el modelo exacto del iPhone</p>
              </div>
              <div>
                <label class="block text-sm font-semibold text-slate-300 mb-2">
                  Capacidad <span class="text-rose-400">*</span>
                </label>
                <input type="text" id="capacidad" name="capacidad" required 
                       placeholder="Ej: 128GB, 256GB, 512GB, 1TB" 
                       class="w-full rounded-xl border-2 border-slate-600/40 bg-slate-800/90 px-4 py-3 text-sm text-slate-100 placeholder-slate-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30">
                <p class="mt-1 text-xs text-slate-500">Capacidad de almacenamiento</p>
              </div>
              <div>
                <label class="block text-sm font-semibold text-slate-300 mb-2">
                  Valor Base de Canje (USD) <span class="text-rose-400">*</span>
                </label>
                <div class="flex items-center gap-2">
                  <span class="text-slate-400">US$</span>
                  <input type="number" id="valor-base" name="valor_base_canje_usd" required step="0.01" min="0"
                         placeholder="0.00" 
                         class="flex-1 rounded-xl border-2 border-slate-600/40 bg-slate-800/90 px-4 py-3 text-sm text-slate-100 placeholder-slate-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30">
                </div>
                <p class="mt-1 text-xs text-slate-500">Valor base en d√≥lares que se le dar√° por este iPhone</p>
              </div>
              <div class="flex items-center">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="checkbox" id="activo" name="activo" checked 
                         class="rounded border-slate-600 bg-slate-700 text-indigo-600 focus:ring-indigo-500">
                  <span class="text-sm font-semibold text-slate-300">Configuraci√≥n activa</span>
                </label>
                <p class="ml-4 text-xs text-slate-500">Si est√° inactiva, no aparecer√° en la calculadora</p>
              </div>
            </div>
          </div>

          <!-- Descuentos por Bater√≠a -->
          <div class="rounded-2xl border border-slate-600/40 bg-slate-800/50 p-6">
            <h3 class="mb-4 text-lg font-semibold text-slate-100">Descuentos por Salud de Bater√≠a</h3>
            <p class="mb-4 text-xs text-slate-400">Ingres√° el porcentaje de descuento (como decimal, ej: 0.15 = 15%)</p>
            <div class="grid gap-4 md:grid-cols-3">
              <div>
                <label class="block text-sm font-semibold text-slate-300 mb-2">Bater√≠a menor a 80%</label>
                <div class="flex items-center gap-2">
                  <input type="number" id="desc-bat-80" step="0.01" min="0" max="1" value="0.15" 
                         placeholder="0.15" 
                         class="flex-1 rounded-xl border-2 border-slate-600/40 bg-slate-800/90 px-4 py-3 text-sm text-slate-100 placeholder-slate-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30">
                  <span class="text-xs text-slate-400 w-12 text-right" id="desc-bat-80-pct">15%</span>
                </div>
              </div>
              <div>
                <label class="block text-sm font-semibold text-slate-300 mb-2">Bater√≠a 80% - 90%</label>
                <div class="flex items-center gap-2">
                  <input type="number" id="desc-bat-80-90" step="0.01" min="0" max="1" value="0.10" 
                         placeholder="0.10" 
                         class="flex-1 rounded-xl border-2 border-slate-600/40 bg-slate-800/90 px-4 py-3 text-sm text-slate-100 placeholder-slate-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30">
                  <span class="text-xs text-slate-400 w-12 text-right" id="desc-bat-80-90-pct">10%</span>
                </div>
              </div>
              <div>
                <label class="block text-sm font-semibold text-slate-300 mb-2">Bater√≠a mayor a 90%</label>
                <div class="flex items-center gap-2">
                  <input type="number" id="desc-bat-90" step="0.01" min="0" max="1" value="0.0" 
                         placeholder="0.0" 
                         class="flex-1 rounded-xl border-2 border-slate-600/40 bg-slate-800/90 px-4 py-3 text-sm text-slate-100 placeholder-slate-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30">
                  <span class="text-xs text-slate-400 w-12 text-right" id="desc-bat-90-pct">0%</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Descuentos por Estado F√≠sico -->
          <div class="rounded-2xl border border-slate-600/40 bg-slate-800/50 p-6">
            <h3 class="mb-4 text-lg font-semibold text-slate-100">Descuentos por Estado F√≠sico</h3>
            <p class="mb-4 text-xs text-slate-400">Ingres√° el porcentaje de descuento seg√∫n el estado del equipo</p>
            <div class="grid gap-4 md:grid-cols-3">
              <div>
                <label class="block text-sm font-semibold text-emerald-400 mb-2">‚ú® Excelente</label>
                <div class="flex items-center gap-2">
                  <input type="number" id="desc-est-excelente" step="0.01" min="0" max="1" value="0.0" 
                         placeholder="0.0" 
                         class="flex-1 rounded-xl border-2 border-slate-600/40 bg-slate-800/90 px-4 py-3 text-sm text-slate-100 placeholder-slate-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30">
                  <span class="text-xs text-slate-400 w-12 text-right" id="desc-est-excelente-pct">0%</span>
                </div>
              </div>
              <div>
                <label class="block text-sm font-semibold text-yellow-400 mb-2">üëç Bueno</label>
                <div class="flex items-center gap-2">
                  <input type="number" id="desc-est-bueno" step="0.01" min="0" max="1" value="0.05" 
                         placeholder="0.05" 
                         class="flex-1 rounded-xl border-2 border-slate-600/40 bg-slate-800/90 px-4 py-3 text-sm text-slate-100 placeholder-slate-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30">
                  <span class="text-xs text-slate-400 w-12 text-right" id="desc-est-bueno-pct">5%</span>
                </div>
              </div>
              <div>
                <label class="block text-sm font-semibold text-orange-400 mb-2">‚ö†Ô∏è Regular</label>
                <div class="flex items-center gap-2">
                  <input type="number" id="desc-est-regular" step="0.01" min="0" max="1" value="0.15" 
                         placeholder="0.15" 
                         class="flex-1 rounded-xl border-2 border-slate-600/40 bg-slate-800/90 px-4 py-3 text-sm text-slate-100 placeholder-slate-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30">
                  <span class="text-xs text-slate-400 w-12 text-right" id="desc-est-regular-pct">15%</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Descuentos por Componentes -->
          <div class="rounded-2xl border border-slate-600/40 bg-slate-800/50 p-6">
            <h3 class="mb-4 text-lg font-semibold text-slate-100">Descuentos por Estado de Componentes</h3>
            <p class="mb-4 text-xs text-slate-400">Ingres√° el porcentaje de descuento seg√∫n el estado de cada componente (como decimal, ej: 0.15 = 15%)</p>
            
            <!-- Pantalla -->
            <div class="mb-6">
              <h4 class="mb-3 text-sm font-semibold text-slate-200">Pantalla</h4>
              <div class="grid gap-3 md:grid-cols-4">
                <div>
                  <label class="block text-xs text-slate-400 mb-1">Perfecta</label>
                  <div class="flex items-center gap-2">
                    <input type="number" id="desc-pantalla-perfecta" step="0.01" min="0" max="1" value="0.0" 
                           class="flex-1 rounded-lg border border-slate-600/40 bg-slate-800/90 px-3 py-2 text-xs text-slate-100 focus:border-indigo-500 focus:outline-none">
                    <span class="text-xs text-slate-500 w-10 text-right" id="desc-pantalla-perfecta-pct">0%</span>
                  </div>
                </div>
                <div>
                  <label class="block text-xs text-slate-400 mb-1">Rayas menores</label>
                  <div class="flex items-center gap-2">
                    <input type="number" id="desc-pantalla-rayas-menores" step="0.01" min="0" max="1" value="0.03" 
                           class="flex-1 rounded-lg border border-slate-600/40 bg-slate-800/90 px-3 py-2 text-xs text-slate-100 focus:border-indigo-500 focus:outline-none">
                    <span class="text-xs text-slate-500 w-10 text-right" id="desc-pantalla-rayas-menores-pct">3%</span>
                  </div>
                </div>
                <div>
                  <label class="block text-xs text-slate-400 mb-1">Rayas visibles</label>
                  <div class="flex items-center gap-2">
                    <input type="number" id="desc-pantalla-rayas-visibles" step="0.01" min="0" max="1" value="0.08" 
                           class="flex-1 rounded-lg border border-slate-600/40 bg-slate-800/90 px-3 py-2 text-xs text-slate-100 focus:border-indigo-500 focus:outline-none">
                    <span class="text-xs text-slate-500 w-10 text-right" id="desc-pantalla-rayas-visibles-pct">8%</span>
                  </div>
                </div>
                <div>
                  <label class="block text-xs text-slate-400 mb-1">Grieta</label>
                  <div class="flex items-center gap-2">
                    <input type="number" id="desc-pantalla-grieta" step="0.01" min="0" max="1" value="0.15" 
                           class="flex-1 rounded-lg border border-slate-600/40 bg-slate-800/90 px-3 py-2 text-xs text-slate-100 focus:border-indigo-500 focus:outline-none">
                    <span class="text-xs text-slate-500 w-10 text-right" id="desc-pantalla-grieta-pct">15%</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Marco -->
            <div class="mb-6">
              <h4 class="mb-3 text-sm font-semibold text-slate-200">Marco</h4>
              <div class="grid gap-3 md:grid-cols-4">
                <div>
                  <label class="block text-xs text-slate-400 mb-1">Perfecto</label>
                  <div class="flex items-center gap-2">
                    <input type="number" id="desc-marco-perfecto" step="0.01" min="0" max="1" value="0.0" 
                           class="flex-1 rounded-lg border border-slate-600/40 bg-slate-800/90 px-3 py-2 text-xs text-slate-100 focus:border-indigo-500 focus:outline-none">
                    <span class="text-xs text-slate-500 w-10 text-right" id="desc-marco-perfecto-pct">0%</span>
                  </div>
                </div>
                <div>
                  <label class="block text-xs text-slate-400 mb-1">Ara√±azos</label>
                  <div class="flex items-center gap-2">
                    <input type="number" id="desc-marco-ara√±azos" step="0.01" min="0" max="1" value="0.02" 
                           class="flex-1 rounded-lg border border-slate-600/40 bg-slate-800/90 px-3 py-2 text-xs text-slate-100 focus:border-indigo-500 focus:outline-none">
                    <span class="text-xs text-slate-500 w-10 text-right" id="desc-marco-ara√±azos-pct">2%</span>
                  </div>
                </div>
                <div>
                  <label class="block text-xs text-slate-400 mb-1">Golpes</label>
                  <div class="flex items-center gap-2">
                    <input type="number" id="desc-marco-golpes" step="0.01" min="0" max="1" value="0.05" 
                           class="flex-1 rounded-lg border border-slate-600/40 bg-slate-800/90 px-3 py-2 text-xs text-slate-100 focus:border-indigo-500 focus:outline-none">
                    <span class="text-xs text-slate-500 w-10 text-right" id="desc-marco-golpes-pct">5%</span>
                  </div>
                </div>
                <div>
                  <label class="block text-xs text-slate-400 mb-1">Deformado</label>
                  <div class="flex items-center gap-2">
                    <input type="number" id="desc-marco-deformado" step="0.01" min="0" max="1" value="0.10" 
                           class="flex-1 rounded-lg border border-slate-600/40 bg-slate-800/90 px-3 py-2 text-xs text-slate-100 focus:border-indigo-500 focus:outline-none">
                    <span class="text-xs text-slate-500 w-10 text-right" id="desc-marco-deformado-pct">10%</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Botones -->
            <div class="mb-6">
              <h4 class="mb-3 text-sm font-semibold text-slate-200">Botones</h4>
              <div class="grid gap-3 md:grid-cols-3">
                <div>
                  <label class="block text-xs text-slate-400 mb-1">Todos funcionan</label>
                  <div class="flex items-center gap-2">
                    <input type="number" id="desc-botones-todos-funcionan" step="0.01" min="0" max="1" value="0.0" 
                           class="flex-1 rounded-lg border border-slate-600/40 bg-slate-800/90 px-3 py-2 text-xs text-slate-100 focus:border-indigo-500 focus:outline-none">
                    <span class="text-xs text-slate-500 w-10 text-right" id="desc-botones-todos-funcionan-pct">0%</span>
                  </div>
                </div>
                <div>
                  <label class="block text-xs text-slate-400 mb-1">Alguno no funciona</label>
                  <div class="flex items-center gap-2">
                    <input type="number" id="desc-botones-alguno-no-funciona" step="0.01" min="0" max="1" value="0.05" 
                           class="flex-1 rounded-lg border border-slate-600/40 bg-slate-800/90 px-3 py-2 text-xs text-slate-100 focus:border-indigo-500 focus:outline-none">
                    <span class="text-xs text-slate-500 w-10 text-right" id="desc-botones-alguno-no-funciona-pct">5%</span>
                  </div>
                </div>
                <div>
                  <label class="block text-xs text-slate-400 mb-1">Varios no funcionan</label>
                  <div class="flex items-center gap-2">
                    <input type="number" id="desc-botones-varios-no-funcionan" step="0.01" min="0" max="1" value="0.10" 
                           class="flex-1 rounded-lg border border-slate-600/40 bg-slate-800/90 px-3 py-2 text-xs text-slate-100 focus:border-indigo-500 focus:outline-none">
                    <span class="text-xs text-slate-500 w-10 text-right" id="desc-botones-varios-no-funcionan-pct">10%</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- C√°mara -->
            <div class="mb-6">
              <h4 class="mb-3 text-sm font-semibold text-slate-200">C√°mara</h4>
              <div class="grid gap-3 md:grid-cols-4">
                <div>
                  <label class="block text-xs text-slate-400 mb-1">Perfecta</label>
                  <div class="flex items-center gap-2">
                    <input type="number" id="desc-camara-perfecta" step="0.01" min="0" max="1" value="0.0" 
                           class="flex-1 rounded-lg border border-slate-600/40 bg-slate-800/90 px-3 py-2 text-xs text-slate-100 focus:border-indigo-500 focus:outline-none">
                    <span class="text-xs text-slate-500 w-10 text-right" id="desc-camara-perfecta-pct">0%</span>
                  </div>
                </div>
                <div>
                  <label class="block text-xs text-slate-400 mb-1">Rayas menores</label>
                  <div class="flex items-center gap-2">
                    <input type="number" id="desc-camara-rayas-menores" step="0.01" min="0" max="1" value="0.02" 
                           class="flex-1 rounded-lg border border-slate-600/40 bg-slate-800/90 px-3 py-2 text-xs text-slate-100 focus:border-indigo-500 focus:outline-none">
                    <span class="text-xs text-slate-500 w-10 text-right" id="desc-camara-rayas-menores-pct">2%</span>
                  </div>
                </div>
                <div>
                  <label class="block text-xs text-slate-400 mb-1">Rayas visibles</label>
                  <div class="flex items-center gap-2">
                    <input type="number" id="desc-camara-rayas-visibles" step="0.01" min="0" max="1" value="0.05" 
                           class="flex-1 rounded-lg border border-slate-600/40 bg-slate-800/90 px-3 py-2 text-xs text-slate-100 focus:border-indigo-500 focus:outline-none">
                    <span class="text-xs text-slate-500 w-10 text-right" id="desc-camara-rayas-visibles-pct">5%</span>
                  </div>
                </div>
                <div>
                  <label class="block text-xs text-slate-400 mb-1">Rota</label>
                  <div class="flex items-center gap-2">
                    <input type="number" id="desc-camara-rota" step="0.01" min="0" max="1" value="0.15" 
                           class="flex-1 rounded-lg border border-slate-600/40 bg-slate-800/90 px-3 py-2 text-xs text-slate-100 focus:border-indigo-500 focus:outline-none">
                    <span class="text-xs text-slate-500 w-10 text-right" id="desc-camara-rota-pct">15%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Descuento por Accesorios -->
          <div class="rounded-2xl border border-slate-600/40 bg-slate-800/50 p-6">
            <h3 class="mb-4 text-lg font-semibold text-slate-100">Descuento por Falta de Caja Original</h3>
            <p class="mb-4 text-xs text-slate-400">Descuento aplicado si el cliente no trae la caja original</p>
            <div class="max-w-xs">
              <div class="flex items-center gap-2">
                <input type="number" id="desc-sin-caja" step="0.01" min="0" max="1" value="0.02" 
                       placeholder="0.02" 
                       class="flex-1 rounded-xl border-2 border-slate-600/40 bg-slate-800/90 px-4 py-3 text-sm text-slate-100 placeholder-slate-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30">
                <span class="text-xs text-slate-400 w-12 text-right" id="desc-sin-caja-pct">2%</span>
              </div>
            </div>
          </div>

          <!-- Gu√≠as de Ayuda -->
          <div class="rounded-2xl border border-slate-600/40 bg-slate-800/50 p-6">
            <h3 class="mb-4 text-lg font-semibold text-slate-100">Gu√≠as de Ayuda para el Admin</h3>
            <p class="mb-4 text-xs text-slate-400">Textos que se mostrar√°n al admin para ayudarlo a evaluar el estado del iPhone</p>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-emerald-400 mb-2">‚ú® Gu√≠a para "Excelente"</label>
                <textarea id="guia-excelente" rows="2" 
                          placeholder="Ej: Sin rayas, sin golpes visibles, pantalla perfecta, marco sin ara√±azos" 
                          class="w-full rounded-xl border-2 border-slate-600/40 bg-slate-800/90 px-4 py-3 text-sm text-slate-100 placeholder-slate-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30"></textarea>
              </div>
              <div>
                <label class="block text-sm font-semibold text-yellow-400 mb-2">üëç Gu√≠a para "Bueno"</label>
                <textarea id="guia-bueno" rows="2" 
                          placeholder="Ej: 1-2 rayitas menores, peque√±os ara√±azos en marco, pantalla sin da√±os" 
                          class="w-full rounded-xl border-2 border-slate-600/40 bg-slate-800/90 px-4 py-3 text-sm text-slate-100 placeholder-slate-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30"></textarea>
              </div>
              <div>
                <label class="block text-sm font-semibold text-orange-400 mb-2">‚ö†Ô∏è Gu√≠a para "Regular"</label>
                <textarea id="guia-regular" rows="2" 
                          placeholder="Ej: M√∫ltiples rayas, golpes visibles, pantalla con da√±os menores" 
                          class="w-full rounded-xl border-2 border-slate-600/40 bg-slate-800/90 px-4 py-3 text-sm text-slate-100 placeholder-slate-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30"></textarea>
              </div>
            </div>
          </div>

          <!-- Botones -->
          <div class="flex gap-3 pt-4">
            <button type="button" id="cancelar-form" class="flex-1 rounded-xl border border-slate-600/50 bg-slate-800/50 px-6 py-3 text-sm font-semibold text-slate-300 hover:bg-slate-700/50 transition">
              Cancelar
            </button>
            <button type="submit" class="flex-1 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-3 text-sm font-semibold text-white shadow-lg shadow-indigo-600/30 transition hover:from-indigo-500 hover:to-purple-500">
              Guardar Configuraci√≥n
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Tabla de Configuraciones -->
    <div class="glass rounded-3xl p-6 shadow-xl border border-slate-600/30">
      <div class="mb-6 flex items-center justify-between">
        <div>
          <h2 class="text-2xl font-bold text-slate-100">Configuraciones Existentes</h2>
          <p class="mt-1 text-sm text-slate-400">Gestion√° los valores base y descuentos para cada modelo y capacidad</p>
        </div>
        <div class="text-right">
          <p class="text-sm font-semibold text-slate-300">{{ configs|length }}</p>
          <p class="text-xs text-slate-500">Configuraciones</p>
        </div>
      </div>
      
      {% if configs %}
        <div class="overflow-x-auto rounded-2xl border border-slate-600/30 bg-slate-800/30">
          <table class="w-full">
            <thead>
              <tr class="border-b border-slate-600/40 bg-slate-800/50">
                <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider text-slate-300">Modelo</th>
                <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider text-slate-300">Capacidad</th>
                <th class="px-6 py-4 text-right text-xs font-bold uppercase tracking-wider text-slate-300">Valor Base (USD)</th>
                <th class="px-6 py-4 text-center text-xs font-bold uppercase tracking-wider text-slate-300">Estado</th>
                <th class="px-6 py-4 text-center text-xs font-bold uppercase tracking-wider text-slate-300">Acciones</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-600/20" id="configs-table-body">
              {% for config in configs %}
                <tr class="hover:bg-slate-800/60 transition-colors group" data-config-id="{{ config.id }}">
                  <td class="px-6 py-4">
                    <div class="text-sm font-semibold text-slate-100">{{ config.modelo_iphone }}</div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="text-sm text-slate-300">{{ config.capacidad }}</div>
                  </td>
                  <td class="px-6 py-4 text-right">
                    <div class="text-sm font-bold text-indigo-400">US$ {{ config.valor_base_canje_usd|floatformat:2|intcomma }}</div>
                  </td>
                  <td class="px-6 py-4 text-center">
                    {% if config.activo %}
                      <span class="inline-flex items-center rounded-full bg-emerald-500/20 px-3 py-1.5 text-xs font-bold text-emerald-400 ring-1 ring-emerald-500/30">
                        <span class="mr-1.5 h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
                        Activo
                      </span>
                    {% else %}
                      <span class="inline-flex items-center rounded-full bg-slate-500/20 px-3 py-1.5 text-xs font-bold text-slate-400 ring-1 ring-slate-500/30">
                        <span class="mr-1.5 h-1.5 w-1.5 rounded-full bg-slate-400"></span>
                        Inactivo
                      </span>
                    {% endif %}
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex items-center justify-center gap-2">
                      <button onclick="editarConfig({{ config.id }})" class="inline-flex items-center gap-1.5 rounded-lg bg-indigo-600/20 px-3 py-2 text-xs font-semibold text-indigo-300 transition hover:bg-indigo-600/30 hover:scale-105 ring-1 ring-indigo-500/20">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                        Editar
                      </button>
                      <button onclick="eliminarConfig({{ config.id }})" class="inline-flex items-center gap-1.5 rounded-lg bg-rose-600/20 px-3 py-2 text-xs font-semibold text-rose-300 transition hover:bg-rose-600/30 hover:scale-105 ring-1 ring-rose-500/20">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        Eliminar
                      </button>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-center py-16 rounded-2xl border-2 border-dashed border-slate-600/40 bg-slate-800/20">
          <div class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-slate-700/50 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-slate-200 mb-2">No hay configuraciones creadas a√∫n</h3>
          <p class="text-sm text-slate-400 mb-6">Comenz√° creando tu primera configuraci√≥n o precarg√° todos los modelos de iPhone</p>
          <div class="flex flex-col sm:flex-row gap-3 justify-center">
            <button onclick="nuevaConfig()" class="inline-flex items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-3 text-sm font-semibold text-white shadow-lg shadow-indigo-600/30 transition hover:from-indigo-500 hover:to-purple-500">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
              Crear Configuraci√≥n
            </button>
            <button id="btn-precargar-modelos-empty" class="inline-flex items-center justify-center gap-2 rounded-xl bg-gradient-to-r from-emerald-600 to-teal-600 px-6 py-3 text-sm font-semibold text-white shadow-lg shadow-emerald-600/30 transition hover:from-emerald-500 hover:to-teal-500">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
              Precargar Modelos
            </button>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
const csrfToken = '{{ csrf_token }}';
const modal = document.getElementById('config-modal');
const form = document.getElementById('config-form');

// Actualizar porcentajes en tiempo real
document.querySelectorAll('input[type="number"][id^="desc-"]').forEach(input => {
  input.addEventListener('input', function() {
    const pctId = this.id + '-pct';
    const pctEl = document.getElementById(pctId);
    if (pctEl) {
      const value = parseFloat(this.value) || 0;
      pctEl.textContent = (value * 100).toFixed(0) + '%';
    }
  });
});

// Abrir modal para nueva configuraci√≥n
function nuevaConfig() {
  document.getElementById('modal-title').textContent = 'Nueva Configuraci√≥n';
  document.getElementById('config-id').value = '';
  form.reset();
  document.getElementById('activo').checked = true;
  // Valores por defecto
  document.getElementById('desc-bat-80').value = '0.15';
  document.getElementById('desc-bat-80-90').value = '0.10';
  document.getElementById('desc-bat-90').value = '0.0';
  document.getElementById('desc-est-excelente').value = '0.0';
  document.getElementById('desc-est-bueno').value = '0.05';
  document.getElementById('desc-est-regular').value = '0.15';
  document.getElementById('desc-sin-caja').value = '0.02';
  
  // Descuentos componentes por defecto
  document.getElementById('desc-pantalla-perfecta').value = '0.0';
  document.getElementById('desc-pantalla-rayas-menores').value = '0.03';
  document.getElementById('desc-pantalla-rayas-visibles').value = '0.08';
  document.getElementById('desc-pantalla-grieta').value = '0.15';
  
  document.getElementById('desc-marco-perfecto').value = '0.0';
  document.getElementById('desc-marco-ara√±azos').value = '0.02';
  document.getElementById('desc-marco-golpes').value = '0.05';
  document.getElementById('desc-marco-deformado').value = '0.10';
  
  document.getElementById('desc-botones-todos-funcionan').value = '0.0';
  document.getElementById('desc-botones-alguno-no-funciona').value = '0.05';
  document.getElementById('desc-botones-varios-no-funcionan').value = '0.10';
  
  document.getElementById('desc-camara-perfecta').value = '0.0';
  document.getElementById('desc-camara-rayas-menores').value = '0.02';
  document.getElementById('desc-camara-rayas-visibles').value = '0.05';
  document.getElementById('desc-camara-rota').value = '0.15';
  
  // Actualizar porcentajes
  document.querySelectorAll('input[type="number"][id^="desc-"]').forEach(input => {
    input.dispatchEvent(new Event('input'));
  });
  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

// Editar configuraci√≥n
async function editarConfig(configId) {
  try {
    const response = await fetch(`{% url "iphones:plan_canje_config_obtener_api" 0 %}`.replace('0', configId));
    const data = await response.json();
    
    document.getElementById('modal-title').textContent = 'Editar Configuraci√≥n';
    document.getElementById('config-id').value = data.id;
    document.getElementById('modelo-iphone').value = data.modelo_iphone;
    document.getElementById('capacidad').value = data.capacidad;
    document.getElementById('valor-base').value = data.valor_base_canje_usd;
    document.getElementById('activo').checked = data.activo;
    
    // Descuentos bater√≠a
    document.getElementById('desc-bat-80').value = data.descuentos_bateria['<80'] || '0.15';
    document.getElementById('desc-bat-80-90').value = data.descuentos_bateria['80-90'] || '0.10';
    document.getElementById('desc-bat-90').value = data.descuentos_bateria['>90'] || '0.0';
    
    // Descuentos estado
    document.getElementById('desc-est-excelente').value = data.descuentos_estado.excelente || '0.0';
    document.getElementById('desc-est-bueno').value = data.descuentos_estado.bueno || '0.05';
    document.getElementById('desc-est-regular').value = data.descuentos_estado.regular || '0.15';
    
    // Descuento accesorios
    document.getElementById('desc-sin-caja').value = data.descuentos_accesorios.sin_caja || '0.02';
    
    // Descuentos pantalla
    const descPantalla = data.descuentos_pantalla || {};
    document.getElementById('desc-pantalla-perfecta').value = descPantalla.perfecta || '0.0';
    document.getElementById('desc-pantalla-rayas-menores').value = descPantalla.rayas_menores || '0.03';
    document.getElementById('desc-pantalla-rayas-visibles').value = descPantalla.rayas_visibles || '0.08';
    document.getElementById('desc-pantalla-grieta').value = descPantalla.grieta || '0.15';
    
    // Descuentos marco
    const descMarco = data.descuentos_marco || {};
    document.getElementById('desc-marco-perfecto').value = descMarco.perfecto || '0.0';
    document.getElementById('desc-marco-ara√±azos').value = descMarco.ara√±azos || '0.02';
    document.getElementById('desc-marco-golpes').value = descMarco.golpes || '0.05';
    document.getElementById('desc-marco-deformado').value = descMarco.deformado || '0.10';
    
    // Descuentos botones
    const descBotones = data.descuentos_botones || {};
    document.getElementById('desc-botones-todos-funcionan').value = descBotones.todos_funcionan || '0.0';
    document.getElementById('desc-botones-alguno-no-funciona').value = descBotones.alguno_no_funciona || '0.05';
    document.getElementById('desc-botones-varios-no-funcionan').value = descBotones.varios_no_funcionan || '0.10';
    
    // Descuentos c√°mara
    const descCamara = data.descuentos_camara || {};
    document.getElementById('desc-camara-perfecta').value = descCamara.perfecta || '0.0';
    document.getElementById('desc-camara-rayas-menores').value = descCamara.rayas_menores || '0.02';
    document.getElementById('desc-camara-rayas-visibles').value = descCamara.rayas_visibles || '0.05';
    document.getElementById('desc-camara-rota').value = descCamara.rota || '0.15';
    
    // Gu√≠as
    document.getElementById('guia-excelente').value = data.guia_estado_excelente || '';
    document.getElementById('guia-bueno').value = data.guia_estado_bueno || '';
    document.getElementById('guia-regular').value = data.guia_estado_regular || '';
    
    // Actualizar porcentajes
    document.querySelectorAll('input[type="number"][id^="desc-"]').forEach(input => {
      input.dispatchEvent(new Event('input'));
    });
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  } catch (error) {
    alert('Error al cargar la configuraci√≥n: ' + error);
  }
}

// Eliminar configuraci√≥n
async function eliminarConfig(configId) {
  if (!confirm('¬øEst√°s seguro de eliminar esta configuraci√≥n?')) return;
  
  try {
    const response = await fetch(`{% url "iphones:plan_canje_config_eliminar_api" 0 %}`.replace('0', configId), {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
      },
    });
    
    if (response.ok) {
      location.reload();
    } else {
      const data = await response.json();
      alert('Error: ' + (data.error || 'No se pudo eliminar'));
    }
  } catch (error) {
    alert('Error al eliminar: ' + error);
  }
}

// Guardar formulario
form.addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = {
    id: document.getElementById('config-id').value || null,
    modelo_iphone: document.getElementById('modelo-iphone').value,
    capacidad: document.getElementById('capacidad').value,
    valor_base_canje_usd: parseFloat(document.getElementById('valor-base').value),
    descuentos_bateria: {
      '<80': parseFloat(document.getElementById('desc-bat-80').value) || 0,
      '80-90': parseFloat(document.getElementById('desc-bat-80-90').value) || 0,
      '>90': parseFloat(document.getElementById('desc-bat-90').value) || 0,
    },
    descuentos_estado: {
      excelente: parseFloat(document.getElementById('desc-est-excelente').value) || 0,
      bueno: parseFloat(document.getElementById('desc-est-bueno').value) || 0,
      regular: parseFloat(document.getElementById('desc-est-regular').value) || 0,
    },
    descuentos_accesorios: {
      sin_caja: parseFloat(document.getElementById('desc-sin-caja').value) || 0,
    },
    descuentos_pantalla: {
      perfecta: parseFloat(document.getElementById('desc-pantalla-perfecta').value) || 0,
      rayas_menores: parseFloat(document.getElementById('desc-pantalla-rayas-menores').value) || 0,
      rayas_visibles: parseFloat(document.getElementById('desc-pantalla-rayas-visibles').value) || 0,
      grieta: parseFloat(document.getElementById('desc-pantalla-grieta').value) || 0,
    },
    descuentos_marco: {
      perfecto: parseFloat(document.getElementById('desc-marco-perfecto').value) || 0,
      ara√±azos: parseFloat(document.getElementById('desc-marco-ara√±azos').value) || 0,
      golpes: parseFloat(document.getElementById('desc-marco-golpes').value) || 0,
      deformado: parseFloat(document.getElementById('desc-marco-deformado').value) || 0,
    },
    descuentos_botones: {
      todos_funcionan: parseFloat(document.getElementById('desc-botones-todos-funcionan').value) || 0,
      alguno_no_funciona: parseFloat(document.getElementById('desc-botones-alguno-no-funciona').value) || 0,
      varios_no_funcionan: parseFloat(document.getElementById('desc-botones-varios-no-funcionan').value) || 0,
    },
    descuentos_camara: {
      perfecta: parseFloat(document.getElementById('desc-camara-perfecta').value) || 0,
      rayas_menores: parseFloat(document.getElementById('desc-camara-rayas-menores').value) || 0,
      rayas_visibles: parseFloat(document.getElementById('desc-camara-rayas-visibles').value) || 0,
      rota: parseFloat(document.getElementById('desc-camara-rota').value) || 0,
    },
    guia_estado_excelente: document.getElementById('guia-excelente').value,
    guia_estado_bueno: document.getElementById('guia-bueno').value,
    guia_estado_regular: document.getElementById('guia-regular').value,
    activo: document.getElementById('activo').checked,
  };
  
  try {
    const response = await fetch('{% url "iphones:plan_canje_config_guardar_api" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
      },
      body: JSON.stringify(formData),
    });
    
    const data = await response.json();
    
    if (data.error) {
      alert('Error: ' + data.error);
      return;
    }
    
    location.reload();
  } catch (error) {
    alert('Error al guardar: ' + error);
  }
});

// Funci√≥n para precargar modelos
async function precargarModelos(button) {
  if (!confirm('¬øPrecargar todos los modelos de iPhone 11-17 con sus capacidades? Esto crear√° configuraciones con valores base en $0 que podr√°s editar despu√©s.')) {
    return;
  }
  
  button.disabled = true;
  const originalHTML = button.innerHTML;
  button.innerHTML = '<span class="animate-pulse">Precargando...</span>';
  
  try {
    const response = await fetch('{% url "iphones:plan_canje_precargar_modelos_api" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
      },
    });
    
    const data = await response.json();
    
    if (data.error) {
      alert('Error: ' + data.error);
      return;
    }
    
    alert(`¬°Listo! Se crearon ${data.creados} configuraciones nuevas y se actualizaron ${data.actualizados} existentes. Total: ${data.total}`);
    location.reload();
  } catch (error) {
    alert('Error al precargar: ' + error);
  } finally {
    button.disabled = false;
    button.innerHTML = originalHTML;
  }
}

// Precargar modelos (desde header)
const btnPrecargar = document.getElementById('btn-precargar-modelos');
if (btnPrecargar) {
  btnPrecargar.addEventListener('click', () => precargarModelos(btnPrecargar));
}

// Precargar modelos (desde empty state)
const btnPrecargarEmpty = document.getElementById('btn-precargar-modelos-empty');
if (btnPrecargarEmpty) {
  btnPrecargarEmpty.addEventListener('click', () => precargarModelos(btnPrecargarEmpty));
}

// Cerrar modal
document.getElementById('btn-nueva-config').addEventListener('click', nuevaConfig);
document.getElementById('cerrar-modal').addEventListener('click', () => {
  modal.classList.add('hidden');
  modal.classList.remove('flex');
});
document.getElementById('cancelar-form').addEventListener('click', () => {
  modal.classList.add('hidden');
  modal.classList.remove('flex');
});
</script>
{% endblock %}
