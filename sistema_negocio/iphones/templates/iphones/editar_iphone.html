{% extends "base.html" %}

{% block title %}Editar iPhone{% endblock %}

{% block extra_head %}
<style>
  body { background: linear-gradient(135deg, #0f172a 0%, #0b1120 45%, #020617 100%); }
  .glass { backdrop-filter: blur(22px); background: rgba(15, 23, 42, 0.7); border: 1px solid rgba(148, 163, 184, 0.18); }
  label { font-size: 0.75rem; letter-spacing: 0.28em; text-transform: uppercase; color: rgba(148, 163, 184, 0.9); font-weight: 600; }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-transparent pb-16">
  <div class="mx-auto max-w-5xl px-4 pt-10 text-slate-100 sm:px-6 lg:px-10">
    <div class="mb-10 flex flex-col items-start gap-4 sm:flex-row sm:items-center">
      <a href="{% url 'iphones:dashboard' %}" class="flex h-10 w-10 items-center justify-center rounded-full border border-slate-500/50 text-slate-300 transition hover:border-white/60 hover:text-white">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
      </a>
      <div>
        <p class="text-xs uppercase tracking-[0.35em] text-slate-400">Edición avanzada</p>
        <h1 class="text-4xl font-semibold tracking-tight">Editar {{ variante.producto.nombre }}</h1>
        <p class="mt-2 text-sm text-slate-300">Ajusta información, precios y estado del dispositivo.</p>
      </div>
    </div>

    <form method="post" enctype="multipart/form-data" class="space-y-10">
      {% csrf_token %}

      <section class="glass rounded-3xl p-6 shadow-xl">
        <h2 class="text-xl font-semibold text-white">1. Identidad del equipo</h2>
        <div class="mt-6 grid gap-6 md:grid-cols-2">
          <div>
            <label for="{{ form.modelo.id_for_label }}">{{ form.modelo.label }}</label>
            <div class="mt-2">{{ form.modelo }}</div>
          </div>
          <div>
            <label for="{{ form.sku.id_for_label }}">{{ form.sku.label }}</label>
            <div class="mt-2 flex items-center gap-3">
              {{ form.sku }}
              <label class="flex items-center gap-2 text-xs text-slate-300 whitespace-nowrap">
                {{ form.sku_auto }}
                <span>Auto</span>
              </label>
            </div>
          </div>
          <div>
            <label for="{{ form.capacidad.id_for_label }}">{{ form.capacidad.label }}</label>
            <div class="mt-2">{{ form.capacidad }}</div>
          </div>
          <div>
            <label for="{{ form.color.id_for_label }}">{{ form.color.label }}</label>
            <div class="mt-2">{{ form.color }}</div>
          </div>
        </div>
        <div class="mt-6 grid gap-6 md:grid-cols-2">
          <div>
            <label for="{{ form.codigo_barras.id_for_label }}">{{ form.codigo_barras.label }}</label>
            <div class="mt-2 flex items-center gap-3">
              {{ form.codigo_barras }}
              <label class="flex items-center gap-2 text-xs text-slate-300 whitespace-nowrap">
                {{ form.generar_codigo_barras }}
                <span>Generar</span>
              </label>
            </div>
          </div>
          <div>
            <label for="{{ form.qr_code.id_for_label }}">{{ form.qr_code.label }}</label>
            <div class="mt-2 flex items-center gap-3">
              {{ form.qr_code }}
              <label class="flex items-center gap-2 text-xs text-slate-300 whitespace-nowrap">
                {{ form.generar_qr }}
                <span>Generar</span>
              </label>
            </div>
          </div>
        </div>
      </section>

      <section class="glass rounded-3xl p-6 shadow-xl">
        <h2 class="text-xl font-semibold text-white">2. Stock y estado</h2>
        <div class="mt-6 grid gap-6 md:grid-cols-2">
          <div>
            <label for="{{ form.stock_actual.id_for_label }}">{{ form.stock_actual.label }}</label>
            <div class="mt-2">{{ form.stock_actual }}</div>
          </div>
          <div>
            <label for="{{ form.stock_minimo.id_for_label }}">{{ form.stock_minimo.label }}</label>
            <div class="mt-2">{{ form.stock_minimo }}</div>
          </div>
          <div>
            <label for="{{ form.activo.id_for_label }}">{{ form.activo.label }}</label>
            <div class="mt-3 flex items-center gap-3 text-sm text-slate-200">
              <label class="switch-container">
                {{ form.activo }}
                <span class="switch-slider"></span>
              </label>
              <span>Disponible para la venta</span>
            </div>
          </div>
          <div>
            <label for="{{ form.es_plan_canje.id_for_label }}">{{ form.es_plan_canje.label }}</label>
            <div class="mt-3 flex items-center gap-3 text-sm text-slate-200">
              <label class="switch-container">
                {{ form.es_plan_canje }}
                <span class="switch-slider"></span>
              </label>
              <span>Plan canje</span>
            </div>
          </div>
        </div>
      </section>

      <section class="glass rounded-3xl p-6 shadow-xl">
        <h2 class="text-xl font-semibold text-white">3. Condición técnica</h2>
        <div class="mt-6 grid gap-6 md:grid-cols-2">
          <div>
            <label for="{{ form.imei.id_for_label }}">{{ form.imei.label }}</label>
            <div class="mt-2">{{ form.imei }}</div>
          </div>
          <div>
            <label for="{{ form.salud_bateria.id_for_label }}">{{ form.salud_bateria.label }}</label>
            <div class="mt-2">{{ form.salud_bateria }}</div>
          </div>
        </div>
        <div class="mt-6 grid gap-6 md:grid-cols-2">
          <div>
            <label for="{{ form.fallas_observaciones.id_for_label }}">{{ form.fallas_observaciones.label }}</label>
            <div class="mt-2">{{ form.fallas_observaciones }}</div>
          </div>
          <div>
            <label for="{{ form.notas.id_for_label }}">{{ form.notas.label }}</label>
            <div class="mt-2">{{ form.notas }}</div>
          </div>
        </div>
      </section>

      <section class="glass rounded-3xl p-6 shadow-xl">
        <h2 class="text-xl font-semibold text-white">4. Estrategia de precios</h2>
        <div class="mt-6 grid gap-6 md:grid-cols-3">
          <div>
            <label for="{{ form.costo_usd.id_for_label }}">{{ form.costo_usd.label }}</label>
            <div class="mt-2">{{ form.costo_usd }}</div>
          </div>
          <div>
            <label for="{{ form.precio_venta_usd.id_for_label }}">{{ form.precio_venta_usd.label }}</label>
            <div class="mt-2">{{ form.precio_venta_usd }}</div>
          </div>
          <div>
            <label for="{{ form.precio_oferta_usd.id_for_label }}">{{ form.precio_oferta_usd.label }}</label>
            <div class="mt-2">{{ form.precio_oferta_usd }}</div>
          </div>
        </div>
        <div class="mt-6 grid gap-6 md:grid-cols-3">
          <div>
            <label for="{{ form.precio_venta_ars.id_for_label }}">{{ form.precio_venta_ars.label }}</label>
            <div class="mt-2">{{ form.precio_venta_ars }}</div>
          </div>
          <div>
            <label for="{{ form.precio_mayorista_usd.id_for_label }}">{{ form.precio_mayorista_usd.label }}</label>
            <div class="mt-2">{{ form.precio_mayorista_usd }}</div>
          </div>
          <div>
            <label for="{{ form.precio_mayorista_ars.id_for_label }}">{{ form.precio_mayorista_ars.label }}</label>
            <div class="mt-2">{{ form.precio_mayorista_ars }}</div>
          </div>
        </div>
      </section>

      <section class="glass rounded-3xl p-6 shadow-xl">
        <h2 class="text-xl font-semibold text-white">5. Imagen</h2>
        <div class="mt-6 grid gap-6 md:grid-cols-2">
          <div>
            <label for="{{ form.foto.id_for_label }}">{{ form.foto.label }}</label>
            <div class="mt-2">{{ form.foto }}</div>
          </div>
          {% if detalle and detalle.foto %}
            <div>
              <span class="text-xs uppercase tracking-[0.3em] text-slate-400">Actual</span>
              <div class="mt-2 overflow-hidden rounded-2xl border border-slate-500/40">
                <img src="{{ detalle.foto.url }}" alt="Foto actual" class="w-full object-cover" />
              </div>
            </div>
          {% endif %}
        </div>
      </section>

      {% if form.errors %}
        <div class="rounded-3xl border border-rose-500/40 bg-rose-500/20 p-6 text-sm text-rose-100">
          <p class="font-semibold uppercase tracking-[0.2em]">Corrige los siguientes campos:</p>
          <ul class="mt-3 space-y-1">
            {% for field, errors in form.errors.items %}
              {% for error in errors %}
                <li><strong>{{ field|capfirst }}:</strong> {{ error }}</li>
              {% endfor %}
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      <div class="flex flex-col gap-3 sm:flex-row sm:justify-end">
        <a href="{% url 'iphones:dashboard' %}" class="rounded-2xl border border-slate-400/60 px-6 py-3 text-center text-sm font-semibold text-slate-200 transition hover:bg-white/10">Cancelar</a>
        <button type="submit" class="rounded-2xl bg-white px-6 py-3 text-sm font-semibold text-slate-900 shadow-lg transition hover:bg-slate-100">Guardar cambios</button>
      </div>
    </form>
  </div>
</div>

<script>
(function() {
    const nombreInput = document.querySelector('[name="modelo"]');
    const skuInput = document.getElementById('sku-input');
    const skuAutoToggle = document.getElementById('sku-auto-toggle');
    const capacidad = document.querySelector('[name="capacidad"]');
    const color = document.querySelector('[name="color"]');
    const codigoBarrasInput = document.getElementById('codigo-barras-input');
    const qrCodeInput = document.getElementById('qr-code-input');

    // SKU automático - siempre generar si está vacío
    function generarSKU() {
        const modelo = nombreInput?.value || '';
        const cap = capacidad?.value || '';
        const col = color?.value || '';
        const sku = `${modelo}-${cap}-${col}`.toUpperCase()
            .replace(/[^A-Z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
        if (sku && skuInput) {
            // Solo actualizar si está vacío o si el toggle está activado
            if (!skuInput.value || (skuAutoToggle && skuAutoToggle.checked)) {
                skuInput.value = sku;
            }
        }
    }

    // Generar automáticamente al cargar si está vacío
    if (skuInput && !skuInput.value && nombreInput && nombreInput.value) {
        generarSKU();
    }

    [nombreInput, capacidad, color].forEach(el => {
        if (el) el.addEventListener('change', generarSKU);
    });
    if (skuAutoToggle && skuInput) {
        skuAutoToggle.addEventListener('change', function() {
            skuInput.readOnly = this.checked;
            if (this.checked) generarSKU();
        });
        if (skuAutoToggle.checked) {
            skuInput.readOnly = true;
            generarSKU();
        }
    }
    
    // Generar código de barras automáticamente
    const generarBarcodeCheckbox = document.querySelector('[name="generar_codigo_barras"]');
    if (generarBarcodeCheckbox && codigoBarrasInput) {
        generarBarcodeCheckbox.addEventListener('change', function() {
            if (this.checked && !codigoBarrasInput.value) {
                const randomCode = Math.floor(100000000000 + Math.random() * 900000000000);
                codigoBarrasInput.value = randomCode.toString();
            }
        });
    }
    
    // Generar QR automáticamente
    const generarQrCheckbox = document.querySelector('[name="generar_qr"]');
    if (generarQrCheckbox && qrCodeInput && skuInput) {
        generarQrCheckbox.addEventListener('change', function() {
            if (this.checked && !qrCodeInput.value && skuInput.value) {
                qrCodeInput.value = `https://importstore.com/producto/${skuInput.value}`;
            }
        });
    }
})();
</script>
{% endblock %}
