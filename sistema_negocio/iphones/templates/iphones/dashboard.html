{% extends "base.html" %}
{% load humanize %}

{% block title %}Gestión de iPhones{% endblock %}

{% block extra_head %}
<style>
  body { background: linear-gradient(135deg, #0f172a 0%, #111827 50%, #020617 100%); }
  .glass { backdrop-filter: blur(20px); background: rgba(15, 23, 42, 0.75); border: 1px solid rgba(148, 163, 184, 0.2); }
  .glass-light { backdrop-filter: blur(18px); background: rgba(255, 255, 255, 0.88); }
  .chip { background: rgba(255, 255, 255, 0.14); }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-transparent pb-16">
  <div class="mx-auto max-w-7xl px-6 pt-10">
    <div class="mb-10 flex flex-col gap-6 text-slate-100 lg:flex-row lg:items-center lg:justify-between">
      <div>
        <p class="text-xs uppercase tracking-[0.35em] text-slate-400">Inventario premium</p>
        <h1 class="text-4xl font-semibold tracking-tight">Colección de iPhones</h1>
        <p class="mt-2 max-w-2xl text-sm text-slate-300">Un panel inspirado en iOS para administrar unidades, precios y condición de cada equipo Apple en stock.</p>
      </div>
      <a href="{% url 'iphones:agregar_iphone' %}" class="inline-flex items-center gap-2 rounded-2xl bg-white/90 px-5 py-3 text-sm font-semibold text-slate-900 shadow-lg transition hover:bg-white {% if schema_missing_columns %}pointer-events-none opacity-50{% elif not detalleiphone_ready %}opacity-75{% endif %}">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
        Nuevo iPhone
      </a>
    </div>

    {% if schema_missing_columns %}
      <div class="mb-8 rounded-3xl border border-rose-300/40 bg-rose-100/10 p-4 text-sm text-rose-100">
        Para habilitar la gestión de iPhones ejecutá <code class="font-mono">python manage.py migrate</code>. Faltan las columnas {{ schema_missing_columns|join:', ' }} en Inventario.
      </div>
      <section class="glass mt-8 rounded-3xl p-6 text-sm text-slate-100">
        <p>Luego de completar las migraciones vas a ver aquí las métricas, listados y acciones para cada dispositivo.</p>
      </section>
    {% else %}
      {% if not detalleiphone_ready %}
        <div class="mb-8 rounded-3xl border border-amber-300/40 bg-amber-100/10 p-4 text-sm text-amber-100">
          Para activar la sincronización completa con DetalleIphone ejecutá <code class="font-mono">python manage.py migrate</code> antes de continuar.
        </div>
      {% endif %}

      <section class="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
        <article class="glass rounded-3xl p-5 shadow-xl text-slate-100">
          <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Variantes</p>
          <div class="mt-3 flex items-baseline gap-2">
            <span class="text-3xl font-semibold">{{ stats.variantes }}</span>
            <span class="text-sm text-slate-400">únicas</span>
          </div>
          <p class="mt-2 text-xs text-slate-400">Todas clasificadas bajo categoría Celulares</p>
        </article>
        <article class="glass rounded-3xl p-5 shadow-xl text-slate-100">
          <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Stock</p>
          <div class="mt-3 flex items-baseline gap-2">
            <span class="text-3xl font-semibold">{{ stats.stock }}</span>
            <span class="text-sm text-slate-400">unidades</span>
          </div>
          <p class="mt-2 text-xs text-slate-400">Actualizado automáticamente con cada movimiento</p>
        </article>
        <article class="glass rounded-3xl p-5 shadow-xl text-slate-100">
          <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Valor USD</p>
          <div class="mt-3">
            <span class="text-3xl font-semibold">US$ {{ stats.valor_usd|floatformat:2|intcomma }}</span>
          </div>
          <p class="mt-2 text-xs text-slate-400">Basado en precio minorista más reciente</p>
        </article>
        <article class="glass rounded-3xl p-5 shadow-xl text-slate-100">
          <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Valor ARS</p>
          <div class="mt-3">
            {% if stats.valor_ars is not None %}
              <span class="text-3xl font-semibold">$ {{ stats.valor_ars|floatformat:0|intcomma }}</span>
            {% else %}
              <span class="text-lg font-medium text-slate-400">Sin cotización</span>
            {% endif %}
          </div>
          <p class="mt-2 text-xs text-slate-400">Dólar blue: {{ valor_dolar|default:"—" }}</p>
        </article>
      </section>

      <section class="glass mt-10 rounded-3xl p-6 shadow-xl">
        <form method="get" class="flex flex-col gap-4 lg:flex-row lg:items-end">
          <div class="flex-1">
            <label class="block text-xs font-semibold uppercase tracking-[0.3em] text-slate-300">Buscar</label>
            <div class="mt-2">
              <input type="text" name="q" value="{{ search_query }}" placeholder="Modelo, SKU, color o IMEI" class="w-full rounded-2xl border border-slate-200 bg-white/80 px-4 py-3 text-sm font-medium text-slate-900 shadow-sm placeholder-slate-400 focus:border-black focus:outline-none focus:ring-2 focus:ring-black/10" />
            </div>
          </div>
          <div class="flex gap-4">
            <button class="rounded-2xl bg-white/90 px-5 py-3 text-sm font-semibold text-slate-900 shadow-md transition hover:bg-white">Aplicar</button>
            {% if search_query %}
              <a href="{% url 'iphones:dashboard' %}" class="rounded-2xl border border-slate-300 px-5 py-3 text-sm font-semibold text-slate-200 transition hover:bg-white/10">Limpiar</a>
            {% endif %}
          </div>
        </form>
        {% if search_query %}
          <div class="mt-4 inline-flex rounded-full bg-white/10 px-4 py-1 text-xs font-medium text-slate-200">
            Filtro activo: “{{ search_query }}”
          </div>
        {% endif %}
      </section>

      <section class="glass-light mt-10 rounded-3xl p-6 shadow-2xl">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="text-lg font-semibold text-slate-900">Inventario detallado</h2>
            <p class="text-xs text-slate-500">{{ variantes|length }} resultados actuales</p>
          </div>
        </div>

        <div class="mt-6 overflow-hidden rounded-3xl border border-slate-200 shadow-inner">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200">
              <thead class="bg-slate-100 text-left text-xs uppercase tracking-[0.25em] text-slate-500">
                <tr>
                  <th class="px-5 py-4">Equipo</th>
                  <th class="px-5 py-4">IMEI</th>
                  <th class="px-5 py-4">Stock</th>
                  <th class="px-5 py-4 text-right">Minorista</th>
                  <th class="px-5 py-4 text-right">Mayorista</th>
                  <th class="px-5 py-4 text-center">Estado</th>
                  <th class="px-5 py-4 text-center">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100 bg-white/85 text-sm text-slate-700">
                {% for variante in variantes %}
                  {% with detalle=variante.detalle_cache %}
                    <tr class="hover:bg-white">
                      <td class="px-5 py-4">
                        <div class="flex items-center gap-4">
                          <div class="h-12 w-12 overflow-hidden rounded-2xl border border-slate-200 bg-slate-100">
                            {% if detalle and detalle.foto %}
                              <img src="{{ detalle.foto.url }}" alt="{{ variante.producto.nombre }}" class="h-full w-full object-cover" />
                            {% else %}
                              <div class="flex h-full w-full items-center justify-center text-xs text-slate-400">iPhone</div>
                            {% endif %}
                          </div>
                          <div class="flex flex-col">
                            <span class="font-semibold text-slate-900">{{ variante.producto.nombre }}</span>
                            <span class="text-xs text-slate-500">{{ variante.atributos_display }}</span>
                            <span class="text-[11px] font-medium uppercase tracking-widest text-slate-400">SKU {{ variante.sku }}</span>
                            {% if detalle and detalle.salud_bateria %}
                              <span class="text-[11px] text-emerald-500">Batería {{ detalle.salud_bateria }}%</span>
                            {% endif %}
                            {% if detalle and detalle.es_plan_canje %}
                              <span class="text-[11px] text-sky-500">Plan canje</span>
                            {% endif %}
                          </div>
                        </div>
                      </td>
                      <td class="px-5 py-4 font-mono text-xs text-slate-500">
                        {% if detalleiphone_ready %}
                          {{ detalle.imei|default:"—" }}
                        {% else %}
                          —
                        {% endif %}
                      </td>
                      <td class="px-5 py-4">
                        <div class="text-right">
                          <span class="text-base font-semibold {{ variante.bajo_stock|yesno:'text-rose-600,text-slate-900' }}">{{ variante.stock_actual }}</span>
                          {% if variante.stock_minimo %}
                            <span class="ml-2 text-xs text-slate-400">mín. {{ variante.stock_minimo }}</span>
                          {% endif %}
                        </div>
                      </td>
                      <td class="px-5 py-4 text-right">
                        <div class="text-xs text-slate-500">USD {{ variante.precio_minorista_usd|default:"—" }}</div>
                        <div class="text-xs text-slate-400">ARS {{ variante.precio_minorista_ars|default:"—" }}</div>
                      </td>
                      <td class="px-5 py-4 text-right">
                        <div class="text-xs text-slate-500">USD {{ variante.precio_mayorista_usd|default:"—" }}</div>
                        <div class="text-xs text-slate-400">ARS {{ variante.precio_mayorista_ars|default:"—" }}</div>
                      </td>
                      <td class="px-5 py-4 text-center">
                        {% if variante.activo %}
                          <span class="inline-flex items-center rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700">Activo</span>
                        {% else %}
                          <span class="inline-flex items-center rounded-full bg-slate-200 px-3 py-1 text-xs font-semibold text-slate-600">Inactivo</span>
                        {% endif %}
                        <form action="{% url 'iphones:toggle_iphone_status' variante.producto.id %}" method="POST" class="mt-2 inline-flex">
                          {% csrf_token %}
                          <button class="rounded-full border border-slate-300 px-3 py-1 text-[11px] font-semibold text-slate-500 transition hover:bg-slate-100">{{ variante.producto.activo|yesno:'Desactivar,Activar' }}</button>
                        </form>
                      </td>
                      <td class="px-5 py-4">
                        <div class="flex items-center justify-center gap-3">
                          <a href="{% url 'iphones:editar_iphone' variante.id %}" class="rounded-full border border-slate-300 px-3 py-1 text-xs font-semibold text-slate-600 transition hover:bg-slate-100">Editar</a>
                          <button onclick="openDeleteModal('{{ variante.id }}', '{{ variante.producto.nombre }} {{ variante.atributos_display }}')" class="rounded-full border border-rose-200 px-3 py-1 text-xs font-semibold text-rose-500 transition hover:bg-rose-50">Eliminar</button>
                        </div>
                      </td>
                    </tr>
                  {% endwith %}
                {% empty %}
                  <tr>
                    <td colspan="7" class="px-5 py-14 text-center text-sm text-slate-500">No hay iPhones que coincidan con tu búsqueda.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>
    {% endif %}
  </div>
</div>

<div id="delete-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/70 px-4">
  <div class="glass-light w-full max-w-md rounded-3xl p-6 shadow-2xl">
    <h3 class="text-xl font-semibold text-slate-900">¿Eliminar iPhone?</h3>
    <p class="mt-2 text-sm text-slate-600">Eliminarás definitivamente <strong id="modal-iphone-name"></strong>. Esta acción no se puede deshacer.</p>
    <div class="mt-6 flex justify-end gap-3">
      <button onclick="closeDeleteModal()" class="rounded-full border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100">Cancelar</button>
      <form id="delete-form" method="POST">
        {% csrf_token %}
        <button type="submit" class="rounded-full bg-rose-600 px-4 py-2 text-sm font-semibold text-white hover:bg-rose-500">Eliminar</button>
      </form>
    </div>
  </div>
</div>

<script>
  const deleteModal = document.getElementById('delete-modal');
  const deleteForm = document.getElementById('delete-form');
  const modalIphoneName = document.getElementById('modal-iphone-name');

  function openDeleteModal(id, name) {
    deleteForm.action = `{% url 'iphones:eliminar_iphone' 0 %}`.replace('/0/', `/${id}/`);
    modalIphoneName.textContent = name;
    deleteModal.classList.remove('hidden');
    deleteModal.classList.add('flex');
  }

  function closeDeleteModal() {
    deleteModal.classList.add('hidden');
    deleteModal.classList.remove('flex');
  }
</script>
{% endblock %}
