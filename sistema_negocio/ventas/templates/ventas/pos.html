{% extends "base.html" %}

{% block title %}Punto de Venta Next-Gen{% endblock %}

{% block extra_head %}
<style>
    main { background: linear-gradient(135deg, #f1f5f9 0%, #e0e7ff 100%); }
    .glass-panel { backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); background: rgba(255, 255, 255, 0.78); }
    @media (max-width: 1024px) {
        #pos-layout { grid-template-columns: minmax(0, 1fr); }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen w-full px-4 py-8 sm:px-6 lg:px-10">
    <header class="mb-8 flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
        <div>
            <p class="text-xs font-semibold uppercase tracking-wider text-indigo-500">POS · ImportStore</p>
            <h1 class="text-3xl font-bold text-slate-900 sm:text-4xl">Terminal de ventas táctil</h1>
            <p class="mt-2 max-w-3xl text-sm text-slate-600">Construí carritos con variantes, aplicá descuentos por producto u operación, registrá métodos de pago mixtos y obtené totales con impuestos.</p>
        </div>
        <div class="flex flex-wrap gap-3 text-xs font-semibold">
            <button id="load-last" class="rounded-full border border-slate-200 bg-white/70 px-4 py-2 text-slate-600 hover:text-slate-900">Última venta</button>
            <button id="export-cart" class="rounded-full bg-slate-900 px-4 py-2 text-white shadow-lg shadow-slate-900/20 hover:bg-slate-800">Exportar comprobante</button>
        </div>
    </header>

    <div id="pos-layout" class="grid gap-6 lg:grid-cols-[minmax(0,3fr)_minmax(0,2fr)]">
        <!-- Lado izquierdo: buscador y carrito -->
        <section class="glass-panel rounded-3xl border border-white/60 p-6 shadow-xl">
            <div class="rounded-3xl border border-slate-200/70 bg-white/90 p-5 shadow-sm">
                <label for="product-search" class="text-xs font-semibold uppercase tracking-wide text-slate-500">Buscar producto</label>
                <div class="relative mt-3">
                    <input id="product-search" type="search" placeholder="Nombre, SKU o atributo" class="w-full rounded-2xl border border-transparent bg-slate-100 px-5 py-3 text-sm text-slate-900 focus:border-slate-300 focus:outline-none focus:ring-2 focus:ring-indigo-500/20">
                    <div id="search-dropdown" class="absolute left-0 top-12 z-20 hidden max-h-72 w-full overflow-y-auto rounded-2xl border border-slate-200/70 bg-white shadow-xl"></div>
                </div>
            </div>

            <div class="mt-6 overflow-hidden rounded-3xl border border-white/60 shadow-inner">
                <table class="min-w-full divide-y divide-slate-200/70 text-sm">
                    <thead class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-500">
                        <tr>
                            <th class="px-4 py-3 text-left">Producto</th>
                            <th class="px-4 py-3 text-center">Cant.</th>
                            <th class="px-4 py-3 text-right">Precio</th>
                            <th class="px-4 py-3 text-right">Desc.</th>
                            <th class="px-4 py-3 text-right">Total</th>
                            <th class="px-4 py-3"></th>
                        </tr>
                    </thead>
                    <tbody id="cart-body" class="divide-y divide-slate-200/70 bg-white/80">
                        <tr id="empty-cart" class="text-center text-sm text-slate-400">
                            <td colspan="6" class="px-4 py-12">Buscá un producto para iniciar la venta.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Lado derecho: resumen -->
        <aside class="glass-panel flex h-full flex-col gap-6 rounded-3xl border border-white/60 p-6 shadow-xl">
            <section class="rounded-3xl border border-slate-200/60 bg-white/90 p-5 shadow-sm">
                <h2 class="text-base font-semibold text-slate-900">Resumen</h2>
                <dl class="mt-4 space-y-3 text-sm text-slate-600">
                    <div class="flex items-center justify-between">
                        <dt>Subtotal</dt>
                        <dd id="summary-subtotal" class="font-semibold text-slate-900">$0.00</dd>
                    </div>
                    <div class="flex items-center justify-between">
                        <dt>Descuentos en ítems</dt>
                        <dd id="summary-item-discount" class="font-semibold text-emerald-600">-$0.00</dd>
                    </div>
                    <div class="flex items-center justify-between">
                        <dt>Descuento general</dt>
                        <dd id="summary-global-discount" class="font-semibold text-emerald-600">-$0.00</dd>
                    </div>
                    <div class="flex items-center justify-between">
                        <dt>Impuestos</dt>
                        <dd id="summary-tax" class="font-semibold text-slate-900">$0.00</dd>
                    </div>
                </dl>
                <div class="mt-5 rounded-2xl border border-slate-200 bg-slate-900 p-5 text-white shadow-lg">
                    <div class="flex items-center justify-between text-sm uppercase tracking-wide text-slate-300">
                        <span>Total a cobrar</span>
                        <span id="summary-items" class="font-semibold">0 ítems</span>
                    </div>
                    <p id="summary-total" class="mt-2 text-3xl font-bold">$0.00</p>
                </div>
            </section>

            <section class="rounded-3xl border border-slate-200/60 bg-white/90 p-5 shadow-sm">
                <h3 class="text-sm font-semibold text-slate-900">Ajustes</h3>
                <div class="mt-4 space-y-4 text-sm">
                    <div>
                        <label class="flex items-center justify-between font-semibold text-slate-600">
                            Descuento general
                            <select id="global-discount-type" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm">
                                <option value="monto">Monto</option>
                                <option value="porcentaje">Porcentaje</option>
                            </select>
                        </label>
                        <input id="global-discount-value" type="number" min="0" step="0.01" class="mt-2 w-full rounded-xl border border-slate-200 px-4 py-2 text-sm" placeholder="0">
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="flex items-center gap-2 text-slate-600"><input type="checkbox" id="toggle-tax" class="h-4 w-4 rounded border-slate-300 text-slate-900 focus:ring-slate-500">Aplicar IVA</label>
                        <input id="tax-rate" type="number" value="21" min="0" step="0.1" class="w-20 rounded-xl border border-slate-200 px-3 py-2 text-sm text-right" disabled>
                    </div>
                    <div>
                        <label for="payment-method" class="block font-semibold text-slate-600">Método de pago</label>
                        <select id="payment-method" class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm">
                            <option value="efectivo">Efectivo</option>
                            <option value="tarjeta">Tarjeta</option>
                            <option value="transferencia">Transferencia</option>
                            <option value="mixto">Mixto</option>
                        </select>
                    </div>
                    <div>
                        <label for="sale-note" class="block font-semibold text-slate-600">Nota interna</label>
                        <textarea id="sale-note" rows="3" class="mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="Observaciones, referencia de pedido o link de pago"></textarea>
                    </div>
                </div>
            </section>

            <button id="complete-sale" class="rounded-3xl bg-slate-900 py-4 text-lg font-semibold text-white shadow-lg shadow-slate-900/20 transition hover:bg-slate-800 disabled:bg-slate-400 disabled:shadow-none">Registrar venta</button>
        </aside>
    </div>

    <template id="cart-row-template">
        <tr class="item-row">
            <td class="px-4 py-4">
                <p class="font-semibold text-slate-900"></p>
                <p class="text-xs text-slate-500"></p>
            </td>
            <td class="px-4 py-4 text-center">
                <input type="number" min="1" class="quantity-input w-20 rounded-xl border border-slate-200 px-2 py-1 text-center" value="1">
            </td>
            <td class="px-4 py-4 text-right font-semibold text-slate-900"><span class="unit-price">$0.00</span></td>
            <td class="px-4 py-4 text-right text-emerald-600"><button class="discount-btn text-xs font-semibold">Configurar</button></td>
            <td class="px-4 py-4 text-right font-semibold text-slate-900"><span class="line-total">$0.00</span></td>
            <td class="px-4 py-4 text-right"><button class="remove-btn text-slate-400 hover:text-rose-500">Eliminar</button></td>
        </tr>
    </template>

    <template id="discount-modal-template">
        <div class="fixed inset-0 z-40 flex items-center justify-center bg-slate-900/60 px-4">
            <div class="w-full max-w-sm rounded-3xl border border-white/60 bg-white p-6 shadow-2xl">
                <h3 class="text-base font-semibold text-slate-900">Descuento en producto</h3>
                <p class="mt-1 text-xs text-slate-500">Aplica a esta línea únicamente</p>
                <div class="mt-4 space-y-3 text-sm">
                    <select class="discount-type w-full rounded-xl border border-slate-200 px-3 py-2 text-sm">
                        <option value="monto">Monto</option>
                        <option value="porcentaje">Porcentaje</option>
                    </select>
                    <input type="number" min="0" step="0.01" class="discount-value w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="0">
                </div>
                <div class="mt-6 flex justify-end gap-3 text-sm font-semibold">
                    <button class="cancel-btn rounded-full border border-slate-200 px-4 py-2 text-slate-500">Cancelar</button>
                    <button class="apply-btn rounded-full bg-slate-900 px-4 py-2 text-white">Aplicar</button>
                </div>
            </div>
        </div>
    </template>
</div>

<script>
    const searchInput = document.getElementById('product-search');
    const searchDropdown = document.getElementById('search-dropdown');
    const cartBody = document.getElementById('cart-body');
    const emptyCart = document.getElementById('empty-cart');
    const cartRowTemplate = document.getElementById('cart-row-template');
    const discountModalTemplate = document.getElementById('discount-modal-template');
    const summarySubtotal = document.getElementById('summary-subtotal');
    const summaryItemDiscount = document.getElementById('summary-item-discount');
    const summaryGlobalDiscount = document.getElementById('summary-global-discount');
    const summaryTax = document.getElementById('summary-tax');
    const summaryTotal = document.getElementById('summary-total');
    const summaryItems = document.getElementById('summary-items');
    const globalDiscountType = document.getElementById('global-discount-type');
    const globalDiscountValue = document.getElementById('global-discount-value');
    const toggleTax = document.getElementById('toggle-tax');
    const taxRate = document.getElementById('tax-rate');
    const paymentMethod = document.getElementById('payment-method');
    const saleNote = document.getElementById('sale-note');
    const completeSale = document.getElementById('complete-sale');
    const loadLast = document.getElementById('load-last');
    const exportCart = document.getElementById('export-cart');

    let cart = [];

    searchInput.addEventListener('input', async () => {
        const query = searchInput.value.trim();
        if (query.length < 2) {
            searchDropdown.classList.add('hidden');
            return;
        }

        const response = await fetch(`/ventas/api/buscar-productos/?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        renderSearchResults(data.results || []);
    });

    function renderSearchResults(results) {
        if (!results.length) {
            searchDropdown.innerHTML = '<div class="p-4 text-sm text-slate-500">Sin resultados.</div>';
            searchDropdown.classList.remove('hidden');
            return;
        }

        searchDropdown.innerHTML = '';
        results.forEach(item => {
            const option = document.createElement('button');
            option.className = 'flex w-full flex-col items-start gap-1 border-b border-slate-100 px-5 py-3 text-left text-sm hover:bg-slate-50';
            option.innerHTML = `
                <span class="font-semibold text-slate-900">${item.producto}</span>
                <span class="text-xs text-slate-500">SKU: ${item.sku} · ${item.atributos || 'Sin atributos'}</span>
                <span class="text-xs text-slate-500">Stock: ${item.stock}</span>`;
            option.addEventListener('click', () => {
                addToCart(item);
                searchDropdown.classList.add('hidden');
                searchInput.value = '';
            });
            searchDropdown.appendChild(option);
        });
        searchDropdown.classList.remove('hidden');
    }

    document.addEventListener('click', (event) => {
        if (!event.target.closest('#product-search') && !event.target.closest('#search-dropdown')) {
            searchDropdown.classList.add('hidden');
        }
    });

    function addToCart(item) {
        const existing = cart.find(line => line.variante_id === item.id);
        if (existing) {
            existing.cantidad += 1;
        } else {
            cart.push({
                variante_id: item.id,
                nombre: item.producto,
                descripcion: item.atributos,
                sku: item.sku,
                cantidad: 1,
                precios: item.precios,
                precio_unitario: parseFloat(item.precios.minorista_usd || item.precios.minorista_ars || 0),
                descuento: null,
            });
        }
        renderCart();
    }

    function renderCart() {
        cartBody.innerHTML = '';
        if (!cart.length) {
            emptyCart.style.display = '';
            summarySubtotal.textContent = '$0.00';
            summaryItemDiscount.textContent = '-$0.00';
            summaryGlobalDiscount.textContent = '-$0.00';
            summaryTax.textContent = '$0.00';
            summaryTotal.textContent = '$0.00';
            summaryItems.textContent = '0 ítems';
            completeSale.disabled = true;
            return;
        }
        emptyCart.style.display = 'none';
        completeSale.disabled = false;

        cart.forEach((item, index) => {
            const clone = cartRowTemplate.content.cloneNode(true);
            const row = clone.querySelector('tr');
            row.dataset.index = index;
            row.querySelector('p.font-semibold').textContent = item.nombre;
            row.querySelector('p.text-xs').textContent = `${item.descripcion || 'Sin atributos'} · SKU ${item.sku}`;
            const quantityInput = row.querySelector('.quantity-input');
            quantityInput.value = item.cantidad;
            quantityInput.addEventListener('change', (event) => {
                const value = Math.max(1, parseInt(event.target.value, 10) || 1);
                cart[index].cantidad = value;
                renderCart();
            });
            const discountBtn = row.querySelector('.discount-btn');
            discountBtn.addEventListener('click', () => openDiscountModal(index));
            row.querySelector('.remove-btn').addEventListener('click', () => {
                cart.splice(index, 1);
                renderCart();
            });

            const lineTotals = calculateLineTotal(item);
            row.querySelector('.unit-price').textContent = `$${lineTotals.precio.toFixed(2)}`;
            discountBtn.textContent = lineTotals.descuento > 0 ? `-$${lineTotals.descuento.toFixed(2)}` : 'Configurar';
            row.querySelector('.line-total').textContent = `$${lineTotals.total.toFixed(2)}`;
            cartBody.appendChild(clone);
        });

        updateSummary();
    }

    function calculateLineTotal(item) {
        const precio = parseFloat(item.precio_unitario || 0);
        const cantidad = parseInt(item.cantidad, 10) || 1;
        const bruto = precio * cantidad;
        let descuento = 0;
        if (item.descuento) {
            if (item.descuento.tipo === 'monto') {
                descuento = Math.min(bruto, parseFloat(item.descuento.valor));
            } else if (item.descuento.tipo === 'porcentaje') {
                descuento = bruto * (parseFloat(item.descuento.valor) / 100);
            }
        }
        return { precio, cantidad, descuento, total: bruto - descuento };
    }

    function openDiscountModal(index) {
        const modal = discountModalTemplate.content.cloneNode(true);
        const overlay = modal.querySelector('div');
        const typeSelect = overlay.querySelector('.discount-type');
        const valueInput = overlay.querySelector('.discount-value');
        const applyBtn = overlay.querySelector('.apply-btn');
        const cancelBtn = overlay.querySelector('.cancel-btn');

        const current = cart[index].descuento;
        if (current) {
            typeSelect.value = current.tipo;
            valueInput.value = current.valor;
        }

        cancelBtn.addEventListener('click', () => overlay.remove());
        overlay.addEventListener('click', (event) => {
            if (event.target === overlay) overlay.remove();
        });

        applyBtn.addEventListener('click', () => {
            const valor = parseFloat(valueInput.value);
            if (isNaN(valor) || valor < 0) {
                valueInput.focus();
                return;
            }
            cart[index].descuento = { tipo: typeSelect.value, valor };
            overlay.remove();
            renderCart();
        });

        document.body.appendChild(overlay);
    }

    function updateSummary() {
        let subtotal = 0;
        let descuentoItems = 0;
        let itemsCount = 0;

        cart.forEach(item => {
            const totals = calculateLineTotal(item);
            subtotal += totals.precio * totals.cantidad;
            descuentoItems += totals.descuento;
            itemsCount += totals.cantidad;
        });

        let descuentoGeneral = parseFloat(globalDiscountValue.value || 0);
        if (globalDiscountType.value === 'porcentaje') {
            descuentoGeneral = (subtotal - descuentoItems) * (descuentoGeneral / 100);
        }

        if (!toggleTax.checked) {
            taxRate.disabled = true;
        } else {
            taxRate.disabled = false;
        }

        const base = subtotal - descuentoItems - descuentoGeneral;
        const impuesto = toggleTax.checked ? base * (parseFloat(taxRate.value || 0) / 100) : 0;
        const total = base + impuesto;

        summarySubtotal.textContent = `$${subtotal.toFixed(2)}`;
        summaryItemDiscount.textContent = `-$${descuentoItems.toFixed(2)}`;
        summaryGlobalDiscount.textContent = `-$${descuentoGeneral.toFixed(2)}`;
        summaryTax.textContent = `$${impuesto.toFixed(2)}`;
        summaryTotal.textContent = `$${total.toFixed(2)}`;
        summaryItems.textContent = `${itemsCount} ítems`;
    }

    globalDiscountType.addEventListener('change', updateSummary);
    globalDiscountValue.addEventListener('input', updateSummary);
    toggleTax.addEventListener('change', updateSummary);
    taxRate.addEventListener('input', updateSummary);

    completeSale.addEventListener('click', async () => {
        if (!cart.length) return;
        completeSale.disabled = true;

        const payload = {
            items: cart.map(item => ({
                variante_id: item.variante_id,
                cantidad: item.cantidad,
                precio_unitario: item.precio_unitario,
                descuento: item.descuento,
            })),
            descuento_general: { tipo: globalDiscountType.value, valor: parseFloat(globalDiscountValue.value || 0) },
            aplicar_iva: toggleTax.checked,
            iva_porcentaje: parseFloat(taxRate.value || 0),
            metodo_pago: paymentMethod.value,
            nota: saleNote.value,
        };

        const response = await fetch('{% url "ventas:crear_venta_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(payload)
        });

        const data = await response.json();
        if (response.ok) {
            alert(`Venta ${data.venta.numero} registrada. Total: $${data.venta.total}`);
            cart = [];
            renderCart();
            saleNote.value = '';
            globalDiscountValue.value = '';
            toggleTax.checked = false;
            updateSummary();
        } else {
            alert(data.error || 'No se pudo registrar la venta');
        }
        completeSale.disabled = false;
    });

    loadLast.addEventListener('click', () => {
        alert('Próximamente podrás recuperar la última venta emitida desde la base de datos.');
    });

    exportCart.addEventListener('click', () => {
        const resumen = [
            `Total ítems: ${summaryItems.textContent}`,
            `Subtotal: ${summarySubtotal.textContent}`,
            `Descuentos: ${summaryItemDiscount.textContent} + ${summaryGlobalDiscount.textContent}`,
            `Impuestos: ${summaryTax.textContent}`,
            `Total: ${summaryTotal.textContent}`,
            `Método de pago: ${paymentMethod.value}`,
            `Nota: ${saleNote.value}`,
        ].join('\n');
        const blob = new Blob([resumen], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `resumen-pos-${new Date().toISOString()}.txt`;
        link.click();
        URL.revokeObjectURL(url);
    });

    renderCart();
</script>
{% endblock %}

