<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta - ImportStore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <div class="w-3/5 p-6 flex flex-col">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Punto de Venta</h1>
            
            <div class="relative mb-4">
                <input type="text" id="search-bar" placeholder="Buscar producto por nombre o escanear código..." class="w-full p-4 border rounded-lg focus:ring-2 focus:ring-blue-500">
                <div id="search-results" class="absolute z-10 w-full bg-white border rounded-lg mt-1 shadow-lg hidden"></div>
            </div>

            <div class="bg-white rounded-lg shadow-md flex-grow overflow-y-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-3 text-left text-sm font-semibold text-gray-600">Producto</th>
                            <th class="p-3 text-center text-sm font-semibold text-gray-600 w-32">Cantidad</th>
                            <th class="p-3 text-right text-sm font-semibold text-gray-600 w-32">Precio Unit.</th>
                            <th class="p-3 text-right text-sm font-semibold text-gray-600 w-32">Subtotal</th>
                            <th class="p-3 w-12"></th>
                        </tr>
                    </thead>
                    <tbody id="cart-items">
                        <tr id="empty-cart-row" class="text-center">
                            <td colspan="5" class="p-8 text-gray-400">El carrito está vacío</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="w-2/5 bg-white p-6 flex flex-col justify-between shadow-lg">
            <div>
                <h2 class="text-2xl font-bold text-gray-800 border-b pb-4 mb-4">Resumen de la Venta</h2>
                <div class="space-y-3 text-gray-700">
                    <div class="flex justify-between">
                        <span>Subtotal</span>
                        <span id="subtotal" class="font-medium">$0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Descuentos</span>
                        <span id="descuentos" class="font-medium text-green-500">-$0.00</span>
                    </div>
                </div>
                <div class="border-t mt-4 pt-4">
                    <div class="flex justify-between font-bold text-xl text-gray-900">
                        <span>TOTAL</span>
                        <span id="total">$0.00</span>
                    </div>
                </div>
            </div>
            <div class="mt-6">
                <button class="w-full bg-blue-600 text-white font-bold py-4 rounded-lg hover:bg-blue-700 transition-colors text-lg">
                    PROCEDER AL PAGO
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchBar = document.getElementById('search-bar');
            const searchResultsContainer = document.getElementById('search-results');
            const cartItemsContainer = document.getElementById('cart-items');
            const emptyCartRow = document.getElementById('empty-cart-row');
            const subtotalEl = document.getElementById('subtotal');
            const totalEl = document.getElementById('total');

            let cart = [];

            searchBar.addEventListener('input', async (e) => {
                const query = e.target.value;
                if (query.length < 2) {
                    searchResultsContainer.classList.add('hidden');
                    return;
                }
                try {
                    const response = await fetch(`/ventas/api/buscar-productos/?q=${query}`);
                    const productos = await response.json();
                    
                    searchResultsContainer.innerHTML = '';
                    if (productos.length > 0) {
                        searchResultsContainer.classList.remove('hidden');
                        productos.forEach(p => {
                            const resultItem = document.createElement('div');
                            resultItem.className = 'p-3 hover:bg-gray-100 cursor-pointer border-b';
                            resultItem.innerHTML = `<p class="font-semibold">${p.nombre}</p><p class="text-sm text-gray-500">Stock: ${p.stock} | Precio: $${p.precio}</p>`;
                            resultItem.addEventListener('click', () => addProductToCart(p));
                            searchResultsContainer.appendChild(resultItem);
                        });
                    } else {
                        searchResultsContainer.innerHTML = '<p class="p-3 text-gray-500">No se encontraron productos.</p>';
                    }
                } catch (error) { console.error('Error buscando productos:', error); }
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('#search-bar')) {
                    searchResultsContainer.classList.add('hidden');
                }
            });

            function addProductToCart(product) {
                if (parseFloat(product.precio) <= 0) {
                    alert('Este producto no tiene un precio válido cargado. Por favor, configúralo en el panel de administrador.');
                    return;
                }

                if (emptyCartRow) emptyCartRow.style.display = 'none';
                const existingProduct = cart.find(item => item.id === product.id);

                if (existingProduct) {
                    existingProduct.quantity++;
                } else {
                    cart.push({ ...product, quantity: 1 });
                }
                
                renderCart();
                searchBar.value = '';
                searchResultsContainer.classList.add('hidden');
                searchBar.focus();
            }

            function renderCart() {
                cartItemsContainer.innerHTML = '';
                if (cart.length === 0 && emptyCartRow) {
                    emptyCartRow.style.display = 'table-row';
                }

                cart.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b';
                    row.innerHTML = `
                        <td class="p-3"><p class="font-semibold text-gray-800">${item.nombre}</p></td>
                        <td class="p-3">
                            <div class="flex justify-center items-center">
                                <input type="number" value="${item.quantity}" min="1" max="${item.stock}" class="w-16 text-center border rounded-md p-1" data-id="${item.id}">
                            </div>
                        </td>
                        <td class="p-3 text-right">$${parseFloat(item.precio).toFixed(2)}</td>
                        <td class="p-3 text-right font-semibold">$${(item.quantity * item.precio).toFixed(2)}</td>
                        <td class="p-3 text-center">
                            <button class="text-red-500 hover:text-red-700" data-id="${item.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </td>
                    `;
                    cartItemsContainer.appendChild(row);
                });

                cartItemsContainer.querySelectorAll('button[data-id]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.currentTarget.dataset.id);
                        cart = cart.filter(item => item.id !== id);
                        renderCart();
                    });
                });

                cartItemsContainer.querySelectorAll('input[type="number"]').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const id = parseInt(e.target.dataset.id);
                        const newQuantity = parseInt(e.target.value);
                        const productInCart = cart.find(item => item.id === id);
                        if (productInCart) {
                            productInCart.quantity = newQuantity;
                            renderCart();
                        }
                    });
                });

                updateSummary();
            }

            function updateSummary() {
                const subtotal = cart.reduce((acc, item) => acc + (item.quantity * item.precio), 0);
                subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
                totalEl.textContent = `$${subtotal.toFixed(2)}`;
            }
        });
    </script>
</body>
</html>