{% extends "base.html" %}
{% load humanize %}

{% block title %}Dashboard{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="min-h-screen w-full pb-16">
    <div class="mx-auto max-w-7xl px-6 py-12 space-y-10">
        <header class="flex flex-col gap-4 glass-card rounded-3xl px-6 py-8 lg:flex-row lg:items-center lg:justify-between">
            <div>
                <p class="text-xs font-semibold uppercase tracking-[0.35em] text-muted">Centro operativo</p>
                <h1 class="mt-2 text-3xl font-semibold text-slate-100 sm:text-4xl">Hola, {{ user.first_name|default:user.username }} üëã</h1>
                <p class="mt-3 max-w-2xl text-sm text-muted">
                    Seguimiento integral del inventario, conversaciones y ventas en un solo panel. Activ√° las acciones r√°pidas para crear productos, atender clientes o registrar una venta sin salir de este tablero.
                </p>
            </div>
            <div class="glass-card rounded-2xl px-5 py-4 text-slate-100 shadow-lg">
                <div class="rounded-full bg-white/10 px-3 py-2 text-xs uppercase tracking-widest text-slate-200 inline-block mb-2">D√≥lar blue</div>
                <div class="text-3xl font-semibold">
                    {% if valor_blue %}
                        ${{ valor_blue|floatformat:0|intcomma }}
                    {% else %}
                        <span class="text-sm font-normal text-slate-300">Sin conexi√≥n</span>
                    {% endif %}
                </div>
            </div>
        </header>

        {% if schema_warnings %}
            <div class="glass-card rounded-3xl border border-amber-500/40 px-6 py-5 text-sm text-amber-200">
                <h2 class="mb-2 text-sm font-semibold uppercase tracking-wide">Atenci√≥n</h2>
                <ul class="space-y-1">
                    {% for warning in schema_warnings %}
                        <li class="flex items-start gap-2"><span class="mt-[6px] h-2 w-2 rounded-full bg-amber-500"></span><span>{{ warning }}</span></li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        <section class="grid gap-6 lg:grid-cols-3">
            <article class="glass-card rounded-3xl p-6">
                <header class="mb-4 flex items-center justify-between">
                    <div>
                        <p class="text-xs font-semibold uppercase tracking-[0.3em] text-muted">Inventario</p>
                        <h2 class="text-lg font-semibold text-slate-100">Salud del cat√°logo</h2>
                    </div>
                    <span class="rounded-full bg-white/10 px-3 py-1 text-xs font-medium text-slate-200">SKU</span>
                </header>
                {% if inventario_metrics %}
                    <dl class="grid grid-cols-2 gap-4 text-sm">
                        <div class="glass-card rounded-2xl px-4 py-3">
                            <dt class="text-xs uppercase tracking-widest text-muted">Variantes activas</dt>
                            <dd class="mt-1 text-2xl font-semibold text-slate-100">{{ inventario_metrics.total_activos|default:0|intcomma }}</dd>
                        </div>
                        <div class="glass-card rounded-2xl px-4 py-3">
                            <dt class="text-xs uppercase tracking-widest text-muted">Bajo stock</dt>
                            <dd class="mt-1 text-2xl font-semibold text-amber-400">{{ inventario_metrics.total_bajo_stock|default:0|intcomma }}</dd>
                        </div>
                        <div class="glass-card rounded-2xl px-4 py-3">
                            <dt class="text-xs uppercase tracking-widest text-muted">Unidades disponibles</dt>
                            <dd class="mt-1 text-2xl font-semibold text-slate-100">{{ inventario_metrics.unidades_totales|default:0|intcomma }}</dd>
                        </div>
                        <div class="glass-card rounded-2xl px-4 py-3">
                            <dt class="text-xs uppercase tracking-widest text-muted">Valor cat√°logo (ARS)</dt>
                            <dd class="mt-1 text-2xl font-semibold text-slate-100">${{ inventario_metrics.valor_catalogo_ars|default:0|floatformat:0|intcomma }}</dd>
                            {% if inventario_metrics.valor_catalogo_usd %}
                                <p class="mt-2 text-xs text-muted">Referencial: US$ {{ inventario_metrics.valor_catalogo_usd|floatformat:2|intcomma }}</p>
                            {% endif %}
                        </div>
                    </dl>
                {% else %}
                    <p class="text-sm text-muted">Necesitamos que completes las migraciones del m√≥dulo Inventario.</p>
                {% endif %}
            </article>

            <article class="glass-card rounded-3xl p-6">
                <header class="mb-4 flex items-center justify-between">
                    <div>
                        <p class="text-xs font-semibold uppercase tracking-[0.3em] text-muted">CRM</p>
                        <h2 class="text-lg font-semibold text-slate-100">Conversaciones y clientes</h2>
                    </div>
                    <span class="rounded-full bg-indigo-500/20 px-3 py-1 text-xs font-medium text-indigo-300">Chat</span>
                </header>
                {% if crm_metrics %}
                    <dl class="space-y-3 text-sm">
                        <div class="flex items-baseline justify-between">
                            <dt class="text-muted">Clientes registrados</dt>
                            <dd class="text-lg font-semibold text-slate-100">{{ crm_metrics.clientes|default:0|intcomma }}</dd>
                        </div>
                        <div class="flex items-baseline justify-between">
                            <dt class="text-muted">Conversaciones abiertas</dt>
                            <dd class="text-lg font-semibold text-slate-100">{{ crm_metrics.conversaciones_abiertas|default:0|intcomma }}</dd>
                        </div>
                        <div class="flex items-baseline justify-between">
                            <dt class="text-muted">SLA vencidos</dt>
                            <dd class="text-lg font-semibold text-rose-400">{{ crm_metrics.sla_vencidos|default:0|intcomma }}</dd>
                        </div>
                    </dl>
                    <a href="{% url 'crm:panel_chat' %}" class="mt-6 inline-flex items-center justify-center glass-card rounded-full px-4 py-2 text-xs font-semibold uppercase tracking-widest text-slate-100 hover:bg-white/10 transition">Ir al panel</a>
                {% else %}
                    <p class="text-sm text-muted">Aplic√° las migraciones del CRM para ver la actividad.</p>
                {% endif %}
            </article>

            <article class="glass-card rounded-3xl p-6">
                <header class="mb-4 flex items-center justify-between">
                    <div>
                        <p class="text-xs font-semibold uppercase tracking-[0.3em] text-muted">Ventas</p>
                        <h2 class="text-lg font-semibold text-slate-100">√öltimos 30 d√≠as</h2>
                    </div>
                    <span class="rounded-full bg-emerald-500/20 px-3 py-1 text-xs font-medium text-emerald-300">POS</span>
                </header>
                {% if ventas_metrics %}
                    <dl class="space-y-3 text-sm">
                        <div class="flex items-baseline justify-between">
                            <dt class="text-muted">Facturaci√≥n</dt>
                            <dd class="text-lg font-semibold text-slate-100">${{ ventas_metrics.total_periodo|default:0|floatformat:2|intcomma }}</dd>
                        </div>
                        <div class="flex items-baseline justify-between">
                            <dt class="text-muted">Tickets emitidos</dt>
                            <dd class="text-lg font-semibold text-slate-100">{{ ventas_metrics.tickets_periodo|default:0|intcomma }}</dd>
                        </div>
                        <div class="flex items-baseline justify-between">
                            <dt class="text-muted">Ticket promedio</dt>
                            <dd class="text-lg font-semibold text-slate-100">${{ ventas_metrics.ticket_promedio|default:0|floatformat:2|intcomma }}</dd>
                        </div>
                    </dl>
                    <a href="{% url 'ventas:pos' %}" class="mt-6 inline-flex items-center justify-center glass-card rounded-full px-4 py-2 text-xs font-semibold uppercase tracking-widest text-slate-100 hover:bg-white/10 transition">Abrir POS</a>
                {% else %}
                    <p class="text-sm text-muted">Todav√≠a no hay ventas registradas o faltan migraciones del m√≥dulo.</p>
                {% endif %}
            </article>
        </section>

        <!-- An√°lisis financiero del mes -->
        {% if analisis_financiero %}
        <section class="glass-card rounded-3xl p-6">
            <header class="mb-6">
                <p class="text-xs font-semibold uppercase tracking-[0.3em] text-muted">An√°lisis financiero</p>
                <h2 class="text-xl font-semibold text-slate-100">Resumen del mes actual</h2>
            </header>
            <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-4">
                <div class="glass-card rounded-2xl p-5">
                    <p class="text-xs uppercase tracking-widest text-muted mb-2">Total ventas</p>
                    <p class="text-2xl font-bold text-slate-100">${{ analisis_financiero.total_ventas_mes|floatformat:2|intcomma }}</p>
                </div>
                <div class="glass-card rounded-2xl p-5">
                    <p class="text-xs uppercase tracking-widest text-muted mb-2">Costo estimado</p>
                    <p class="text-2xl font-bold text-amber-400">${{ analisis_financiero.total_costo_estimado|floatformat:2|intcomma }}</p>
                </div>
                <div class="glass-card rounded-2xl p-5 {% if analisis_financiero.es_ganancia %}bg-emerald-500/10 border border-emerald-500/30{% else %}bg-rose-500/10 border border-rose-500/30{% endif %}">
                    <p class="text-xs uppercase tracking-widest text-muted mb-2">Ganancia / P√©rdida</p>
                    <p class="text-2xl font-bold {% if analisis_financiero.es_ganancia %}text-emerald-400{% else %}text-rose-400{% endif %}">
                        {% if analisis_financiero.es_ganancia %}+{% endif %}${{ analisis_financiero.total_ganancia_estimada|floatformat:2|intcomma }}
                    </p>
                </div>
                <div class="glass-card rounded-2xl p-5">
                    <p class="text-xs uppercase tracking-widest text-muted mb-2">Margen de ganancia</p>
                    <p class="text-2xl font-bold text-indigo-400">{{ analisis_financiero.margen_porcentaje|floatformat:1 }}%</p>
                    {% if analisis_financiero.items_sin_costo > 0 %}
                    <p class="text-xs text-amber-400 mt-2">‚ö† {{ analisis_financiero.items_sin_costo }} items sin costo registrado</p>
                    {% endif %}
                </div>
            </div>
        </section>
        {% endif %}

        <!-- Gr√°ficos de estad√≠sticas -->
        {% if ventas_ultimos_7_dias or ventas_por_metodo or margenes_por_metodo %}
        <section class="grid gap-6 lg:grid-cols-2">
            {% if ventas_ultimos_7_dias %}
            <article class="glass-card rounded-3xl p-6">
                <header class="mb-4">
                    <p class="text-xs font-semibold uppercase tracking-[0.3em] text-muted">Tendencia de ventas</p>
                    <h2 class="text-lg font-semibold text-slate-100">√öltimos 7 d√≠as</h2>
                </header>
                <div class="h-64">
                    <canvas id="ventasChart"></canvas>
                </div>
            </article>
            {% endif %}
            
            {% if ventas_por_metodo %}
            <article class="glass-card rounded-3xl p-6">
                <header class="mb-4">
                    <p class="text-xs font-semibold uppercase tracking-[0.3em] text-muted">M√©todos de pago</p>
                    <h2 class="text-lg font-semibold text-slate-100">Distribuci√≥n</h2>
                </header>
                <div class="h-64">
                    <canvas id="metodosChart"></canvas>
                </div>
            </article>
            {% endif %}
        </section>
        {% endif %}

        <!-- M√°rgenes por m√©todo de pago -->
        {% if margenes_por_metodo %}
        <section class="grid gap-6 lg:grid-cols-2">
            <article class="glass-card rounded-3xl p-6">
                <header class="mb-4">
                    <p class="text-xs font-semibold uppercase tracking-[0.3em] text-muted">An√°lisis de rentabilidad</p>
                    <h2 class="text-lg font-semibold text-slate-100">M√°rgenes por m√©todo de pago</h2>
                </header>
                <div class="h-80">
                    <canvas id="margenesChart"></canvas>
                </div>
            </article>
            
            <article class="glass-card rounded-3xl p-6">
                <header class="mb-4">
                    <p class="text-xs font-semibold uppercase tracking-[0.3em] text-muted">Desglose detallado</p>
                    <h2 class="text-lg font-semibold text-slate-100">Rentabilidad por m√©todo</h2>
                </header>
                <div class="space-y-3">
                    {% for item in margenes_por_metodo %}
                    <div class="glass-card rounded-2xl p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold text-slate-100">{{ item.metodo }}</h3>
                            <span class="text-xs px-2 py-1 rounded-full bg-indigo-500/20 text-indigo-300">{{ item.cantidad }} ventas</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <p class="text-xs text-muted mb-1">Ventas</p>
                                <p class="font-semibold text-slate-100">${{ item.total_ventas|floatformat:2|intcomma }}</p>
                            </div>
                            <div>
                                <p class="text-xs text-muted mb-1">Costo</p>
                                <p class="font-semibold text-amber-400">${{ item.costo|floatformat:2|intcomma }}</p>
                            </div>
                            <div>
                                <p class="text-xs text-muted mb-1">Ganancia</p>
                                <p class="font-semibold {% if item.ganancia >= 0 %}text-emerald-400{% else %}text-rose-400{% endif %}">
                                    {% if item.ganancia >= 0 %}+{% endif %}${{ item.ganancia|floatformat:2|intcomma }}
                                </p>
                            </div>
                            <div>
                                <p class="text-xs text-muted mb-1">Margen</p>
                                <p class="font-semibold text-indigo-400">{{ item.margen_porcentaje|floatformat:1 }}%</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </article>
        </section>
        {% endif %}

        <section class="grid gap-6 lg:grid-cols-3">
            <div class="space-y-6 lg:col-span-2">
                <article class="glass-card rounded-3xl p-6">
                    <header class="mb-4 flex items-center justify-between">
                        <div>
                            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-muted">Accesos r√°pidos</p>
                            <h2 class="text-lg font-semibold text-slate-100">Acciones frecuentes</h2>
                        </div>
                    </header>
                    <div class="grid gap-4 sm:grid-cols-2">
                        {% for action in quick_actions %}
                            <a href="{{ action.url }}" class="group flex h-full flex-col justify-between glass-card rounded-2xl px-4 py-5 transition hover:-translate-y-0.5 hover:shadow-lg">
                                <div>
                                    <span class="inline-flex rounded-full {{ action.accent }} px-3 py-1 text-xs font-medium">{{ action.title }}</span>
                                    <p class="mt-3 text-sm text-muted">{{ action.description }}</p>
                                </div>
                                <span class="mt-4 inline-flex items-center text-xs font-semibold uppercase tracking-widest text-muted">Ingresar ‚Üí</span>
                            </a>
                        {% endfor %}
                    </div>
                </article>

                <article class="glass-card rounded-3xl p-6">
                    <header class="mb-4 flex items-center justify-between">
                        <div>
                            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-muted">Stock cr√≠tico</p>
                            <h2 class="text-lg font-semibold text-slate-100">Variantes para reponer</h2>
                        </div>
                    </header>
                    {% if low_stock_variantes %}
                        <ul class="divide-y divide-white/10 text-sm">
                            {% for variante in low_stock_variantes %}
                                <li class="flex flex-col gap-1 py-3 sm:flex-row sm:items-center sm:justify-between">
                                    <div>
                                        <p class="font-medium text-slate-100">{{ variante.producto.nombre }}</p>
                                        <p class="text-xs text-muted">SKU {{ variante.sku }} ¬∑ {{ variante.atributos_display|default:"Variante est√°ndar" }}</p>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <span class="text-xs uppercase tracking-widest text-muted">Stock</span>
                                        <span class="text-lg font-semibold text-rose-400">{{ variante.stock_actual }} / {{ variante.stock_minimo }}</span>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-sm text-muted">¬°Buen trabajo! No hay variantes en nivel cr√≠tico.</p>
                    {% endif %}
                </article>

                <article class="glass-card rounded-3xl p-6">
                    <header class="mb-4 flex items-center justify-between">
                        <div>
                            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-muted">Ventas recientes</p>
                            <h2 class="text-lg font-semibold text-slate-100">√öltimos tickets</h2>
                        </div>
                    </header>
                    {% if ultimas_ventas %}
                        <ul class="divide-y divide-white/10 text-sm">
                            {% for venta in ultimas_ventas %}
                                <li class="flex flex-col gap-1 py-3 sm:flex-row sm:items-center sm:justify-between">
                                    <div>
                                        <p class="font-medium text-slate-100">{{ venta.id }}</p>
                                        <p class="text-xs text-muted">{{ venta.fecha|naturaltime }} ¬∑ {{ venta.get_metodo_pago_display }}</p>
                                    </div>
                                    <span class="text-lg font-semibold text-slate-100">${{ venta.total_ars|floatformat:2|intcomma }}</span>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-sm text-muted">A√∫n no registraste ventas en el per√≠odo analizado.</p>
                    {% endif %}
                </article>
            </div>

            <aside class="glass-card rounded-3xl p-6">
                <header class="mb-4">
                    <p class="text-xs font-semibold uppercase tracking-[0.3em] text-muted">Actividad</p>
                    <h2 class="text-lg font-semibold text-slate-100">Bit√°cora reciente</h2>
                </header>
                {% if recent_activity %}
                    <ol class="space-y-4 text-sm">
                        {% for registro in recent_activity %}
                            <li class="glass-card rounded-2xl px-4 py-3">
                                <p class="text-xs uppercase tracking-widest text-muted">{{ registro.fecha|naturaltime }}</p>
                                <p class="mt-1 font-medium text-slate-100">{{ registro.descripcion }}</p>
                                <p class="mt-1 text-xs text-muted">{{ registro.get_tipo_accion_display }} ¬∑ {{ registro.usuario|default:"Sistema" }}</p>
                            </li>
                        {% endfor %}
                    </ol>
                {% else %}
                    <p class="text-sm text-muted">La bit√°cora quedar√° activa cuando haya movimientos en el sistema.</p>
                {% endif %}
            </aside>
        </section>
    </div>
</div>

{% if ventas_ultimos_7_dias %}
{{ ventas_ultimos_7_dias|json_script:"ventas-data" }}
{% endif %}
{% if ventas_por_metodo %}
{{ ventas_por_metodo|json_script:"metodos-data" }}
{% endif %}
{% if margenes_por_metodo %}
{{ margenes_por_metodo|json_script:"margenes-data" }}
{% endif %}

<script>
    // Configuraci√≥n global de Chart.js para modo oscuro
    Chart.defaults.color = '#cbd5e1';
    Chart.defaults.borderColor = 'rgba(148, 163, 184, 0.2)';
    Chart.defaults.backgroundColor = 'rgba(148, 163, 184, 0.1)';

    // Gr√°fico de ventas √∫ltimos 7 d√≠as
    {% if ventas_ultimos_7_dias %}
    const ventasCtx = document.getElementById('ventasChart');
    if (ventasCtx) {
        const ventasData = JSON.parse(document.getElementById('ventas-data').textContent);
        const labels = ventasData.map(v => v.fecha);
        const totals = ventasData.map(v => v.total);
        const cantidades = ventasData.map(v => v.cantidad);

        new Chart(ventasCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Facturaci√≥n ($)',
                        data: totals,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y',
                    },
                    {
                        label: 'Cantidad de tickets',
                        data: cantidades,
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y1',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#cbd5e1',
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        titleColor: '#f1f5f9',
                        bodyColor: '#cbd5e1',
                        borderColor: 'rgba(148, 163, 184, 0.2)',
                        borderWidth: 1,
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        ticks: {
                            color: '#cbd5e1',
                            callback: function(value) {
                                return '$' + value.toLocaleString('es-AR');
                            }
                        },
                        grid: {
                            color: 'rgba(148, 163, 184, 0.1)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        ticks: {
                            color: '#cbd5e1'
                        },
                        grid: {
                            drawOnChartArea: false,
                        }
                    },
                    x: {
                        ticks: {
                            color: '#cbd5e1'
                        },
                        grid: {
                            color: 'rgba(148, 163, 184, 0.1)'
                        }
                    }
                }
            }
        });
    }
    {% endif %}

    // Gr√°fico de m√©todos de pago
    {% if ventas_por_metodo %}
    const metodosCtx = document.getElementById('metodosChart');
    if (metodosCtx) {
        const metodosData = JSON.parse(document.getElementById('metodos-data').textContent);
        const labels = metodosData.map(m => m.metodo);
        const totals = metodosData.map(m => m.total);
        const colors = [
            'rgba(59, 130, 246, 0.8)',
            'rgba(16, 185, 129, 0.8)',
            'rgba(139, 92, 246, 0.8)',
            'rgba(236, 72, 153, 0.8)',
            'rgba(245, 158, 11, 0.8)',
            'rgba(239, 68, 68, 0.8)',
        ];

        new Chart(metodosCtx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: totals,
                    backgroundColor: colors.slice(0, totals.length),
                    borderColor: 'rgba(15, 23, 42, 0.8)',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#cbd5e1',
                            font: {
                                size: 11
                            },
                            padding: 12,
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        titleColor: '#f1f5f9',
                        bodyColor: '#cbd5e1',
                        borderColor: 'rgba(148, 163, 184, 0.2)',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': $' + value.toLocaleString('es-AR') + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}

    // Gr√°fico de m√°rgenes por m√©todo de pago
    {% if margenes_por_metodo %}
    const margenesCtx = document.getElementById('margenesChart');
    if (margenesCtx) {
        const margenesData = JSON.parse(document.getElementById('margenes-data').textContent);
        const labels = margenesData.map(m => m.metodo);
        const ganancias = margenesData.map(m => m.ganancia);
        const costos = margenesData.map(m => m.costo);
        const ventas = margenesData.map(m => m.total_ventas);
        const margenes = margenesData.map(m => m.margen_porcentaje);

        new Chart(margenesCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Ventas ($)',
                        data: ventas,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 0.8)',
                        borderWidth: 2,
                        yAxisID: 'y',
                    },
                    {
                        label: 'Ganancia ($)',
                        data: ganancias,
                        backgroundColor: 'rgba(16, 185, 129, 0.6)',
                        borderColor: 'rgba(16, 185, 129, 0.8)',
                        borderWidth: 2,
                        yAxisID: 'y',
                    },
                    {
                        label: 'Costo ($)',
                        data: costos,
                        backgroundColor: 'rgba(245, 158, 11, 0.6)',
                        borderColor: 'rgba(245, 158, 11, 0.8)',
                        borderWidth: 2,
                        yAxisID: 'y',
                    },
                    {
                        label: 'Margen (%)',
                        data: margenes,
                        type: 'line',
                        borderColor: 'rgba(139, 92, 246, 1)',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        yAxisID: 'y1',
                        pointRadius: 5,
                        pointHoverRadius: 7,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#cbd5e1',
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        titleColor: '#f1f5f9',
                        bodyColor: '#cbd5e1',
                        borderColor: 'rgba(148, 163, 184, 0.2)',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.datasetIndex === 3) {
                                    // Margen porcentaje
                                    label += context.parsed.y.toFixed(1) + '%';
                                } else {
                                    // Valores en pesos
                                    label += '$' + context.parsed.y.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        ticks: {
                            color: '#cbd5e1',
                            callback: function(value) {
                                return '$' + value.toLocaleString('es-AR', {maximumFractionDigits: 0});
                            }
                        },
                        grid: {
                            color: 'rgba(148, 163, 184, 0.1)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        ticks: {
                            color: '#cbd5e1',
                            callback: function(value) {
                                return value.toFixed(1) + '%';
                            }
                        },
                        grid: {
                            drawOnChartArea: false,
                        }
                    },
                    x: {
                        ticks: {
                            color: '#cbd5e1'
                        },
                        grid: {
                            color: 'rgba(148, 163, 184, 0.1)'
                        }
                    }
                }
            }
        });
    }
    {% endif %}
</script>
{% endblock %}